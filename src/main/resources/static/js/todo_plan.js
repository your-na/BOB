// ‚úÖ Ïø†ÌÇ§ÏóêÏÑú CSRF ÌÜ†ÌÅ∞ Í∫ºÎÇ¥Îäî Ìï®Ïàò
function getCookie(name) {
    const value = document.cookie
        .split("; ")
        .find((row) => row.startsWith(name + "="));
    return value ? decodeURIComponent(value.split("=")[1]) : null;
}

document.addEventListener("DOMContentLoaded", function () {
    const calendarBody = document.getElementById("calendar-body");
    const currentMonth = document.getElementById("current-month");
    const prevMonthBtn = document.getElementById("prev-month");
    const nextMonthBtn = document.getElementById("next-month");
    const todoList = document.querySelector(".todo-list");
    const taskTitle = document.querySelector(".task-date-title");

    // ‚úÖ ÏÇ¨Ïù¥ÎìúÎ∞î Î≤ÑÌäº ÎèôÏûë Ï∂îÍ∞Ä
    const sidebarButtons = document.querySelectorAll('.sidebar-btn');
    const projectId = 217; // Ïã§Ï†ú ÏÇ¨Ïö© Ïãú ÎèôÏ†ÅÏúºÎ°ú Ï≤òÎ¶¨ Í∞ÄÎä•

    sidebarButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
            const text = btn.textContent.trim();
            if (text === "Ìôà") {
                window.location.href = `http://localhost:8888/todohome/${projectId}`;
            } else if (text === "CRUD") {
                window.location.href = `http://localhost:8888/todocrud/${projectId}`;
            }
        });
    });

    let selectedDate = null;
    const today = new Date();
    let month = today.getMonth(); // 0~11
    let year = today.getFullYear();


    function renderCalendar() {
        calendarBody.innerHTML = "";
        let firstDay = new Date(year, month, 1).getDay();
        let daysInMonth = new Date(year, month + 1, 0).getDate();
        let row = document.createElement("tr");

        for (let i = 0; i < firstDay; i++) {
            row.appendChild(document.createElement("td"));
        }

        for (let day = 1; day <= daysInMonth; day++) {
            let cell = document.createElement("td");
            cell.textContent = day;
            cell.classList.add("calendar-cell");

            cell.addEventListener("click", function () {

                if (selectedDate) {
                    selectedDate.classList.remove("selected");
                }
                cell.classList.add("selected");
                selectedDate = cell;

                const clickedDate = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                console.log("ÏÑ†ÌÉùÎêú ÎÇ†Ïßú:", clickedDate);

                fetch(`http://localhost:8888/api/todos?date=${clickedDate}`)
                    .then((res) => res.json())
                    .then((data) => {
                        console.log("üì¶ Î∂àÎü¨Ïò® Ìï† Ïùº Ï†ÑÏ≤¥:", data);
                        todoList.innerHTML = "";
                        if (taskTitle) {
                            taskTitle.textContent = `${month + 1}Ïõî ${day}Ïùº Ìï† Ïùº`;
                        }

                        if (data.length === 0) {
                            todoList.innerHTML = "<li>Ìï† ÏùºÏù¥ ÏóÜÏäµÎãàÎã§.</li>";
                            return;
                        }

                        data.forEach(todo => {
                            console.log("üìù Í∞úÎ≥Ñ todo:", todo);
                            const li = document.createElement("li");
                            const checkbox = document.createElement("input");
                            checkbox.type = "checkbox";
                            checkbox.checked = todo.completed;

                            checkbox.addEventListener("change", function () {
                                console.log("üì¶ Ï≤¥ÌÅ¨Î∞ïÏä§ Î≥ÄÍ≤ΩÎê® - ID:", todo.id, "‚úÖ ÏÉÅÌÉú:", checkbox.checked);
                                fetch(`http://localhost:8888/api/todos/${todo.id}/complete`, {
                                    method: "PATCH",
                                    headers: {
                                        "Content-Type": "application/json",
                                        "X-XSRF-TOKEN": getCookie("XSRF-TOKEN")
                                    },
                                    credentials: "include",
                                    body: JSON.stringify({ completed: checkbox.checked })
                                }).then(res => {
                                    if (!res.ok) {
                                        alert("ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®");
                                        checkbox.checked = !checkbox.checked;
                                    }
                                }).catch(err => {
                                    alert("Ïò§Î•ò Î∞úÏÉù: " + err);
                                    checkbox.checked = !checkbox.checked;
                                });
                            });

                            const titleSpan = document.createElement("span");
                            titleSpan.textContent = ` ${todo.title} `;

                            const ddaySpan = document.createElement("span");
                            ddaySpan.classList.add("d-day");
                            ddaySpan.textContent = `D-${getDday(todo.endDate)}`;

                            li.appendChild(checkbox);
                            li.appendChild(titleSpan);
                            li.appendChild(ddaySpan);
                            todoList.appendChild(li);
                        });
                    })
                    .catch(err => {
                        console.error("Ìï† Ïùº Ï°∞Ìöå Ïã§Ìå®:", err);
                        alert("Ìï† ÏùºÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                    });
            });

            row.appendChild(cell);

            if ((firstDay + day) % 7 === 0) {
                calendarBody.appendChild(row);
                row = document.createElement("tr");
            }
        }

        calendarBody.appendChild(row);
        currentMonth.textContent = `${year}ÎÖÑ ${month + 1}Ïõî`;
    }

    function getDday(dateStr) {
        const today = new Date();
        const target = new Date(dateStr);
        const diffTime = target - today;
        const diffDay = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDay >= 0 ? diffDay : 0;
    }

    prevMonthBtn.addEventListener("click", function () {
        month--;
        if (month < 0) {
            month = 11;
            year--;
        }
        renderCalendar();
    });

    nextMonthBtn.addEventListener("click", function () {
        month++;
        if (month > 11) {
            month = 0;
            year++;
        }
        renderCalendar();
    });

    renderCalendar();
    loadMyProjects();
});

// ‚úÖ Ìï† Ïùº Îì±Î°ù Ï≤òÎ¶¨
document.addEventListener("DOMContentLoaded", () => {
    const addTaskBtn = document.querySelector(".add-task-btn");
    const taskModal = document.querySelector(".task-modal");
    const cancelBtn = document.querySelector(".cancel-task-btn");
    const submitBtn = document.querySelector(".submit-task-btn");
    const taskInput = document.querySelector(".task-input");
    const startDateInput = document.querySelector(".start-date");
    const endDateInput = document.querySelector(".end-date");

    addTaskBtn.addEventListener("click", () => {
        taskModal.classList.remove("hidden");
    });

    cancelBtn.addEventListener("click", () => {
        taskModal.classList.add("hidden");
    });

    submitBtn.addEventListener("click", () => {
        const title = taskInput.value.trim();
        const date = startDateInput.value;
        const endDate = endDateInput.value;
        const csrfToken = getCookie("XSRF-TOKEN");

        if (!title || !date || !endDate) {
            alert("Ìï† Ïùº Ï†úÎ™©Í≥º ÎÇ†ÏßúÎ•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!");
            return;
        }

        const todoData = {
            title: title,
            startDate: date,
            endDate: endDate,
            assignee: document.querySelector(".member-select").value,
            workspace: document.querySelector(".space-select").value
        };

        fetch("http://localhost:8888/api/todos", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-XSRF-TOKEN": csrfToken
            },
            credentials: "include",
            body: JSON.stringify(todoData)
        })
            .then((res) => {
                if (!res.ok) {
                    throw new Error("Ìï† Ïùº Ï†ÄÏû• Ïã§Ìå®");
                }
                return res.json();
            })
            .then((data) => {
                console.log("Ìï† Ïùº Ï†ÄÏû• ÏôÑÎ£å:", data);
                taskModal.classList.add("hidden");
                taskInput.value = "";
                startDateInput.value = "";
                endDateInput.value = "";
            })
            .catch((err) => {
                console.error(err);
                alert("Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
            });
    });
});

// ‚úÖ ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
function loadMyProjects() {
    const spaceSelect = document.querySelector(".space-select");

    fetch("http://localhost:8888/api/my-projects", {
        method: "GET",
        credentials: "include"
    })
        .then((res) => res.json())
        .then((projects) => {
            const filteredProjects = projects.filter(project => project.status !== "ÏôÑÎ£å");

            spaceSelect.innerHTML = "";

            filteredProjects.forEach((project) => {
                const option = document.createElement("option");
                option.value = project.title;
                option.textContent = project.title;
                spaceSelect.appendChild(option);
            });

            const personalOption = document.createElement("option");
            personalOption.value = "Í∞úÏù∏";
            personalOption.textContent = "Í∞úÏù∏";
            spaceSelect.appendChild(personalOption);

            spaceSelect.dispatchEvent(new Event("change"));
        })
        .catch((err) => {
            console.error("ÌîÑÎ°úÏ†ùÌä∏Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.", err);
            alert("ÌîÑÎ°úÏ†ùÌä∏Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
        });
}

// ‚úÖ Îã¥ÎãπÏûê Î™©Î°ù ÎèôÏ†Å Î°úÎî©
document.addEventListener("DOMContentLoaded", () => {
    const spaceSelect = document.querySelector(".space-select");
    const memberSelect = document.querySelector(".member-select");

    spaceSelect.addEventListener("change", () => {
        const selectedTitle = spaceSelect.value;

        console.log("‚úÖ ÏÑ†ÌÉùÎêú ÌîÑÎ°úÏ†ùÌä∏ Ï†úÎ™©:", selectedTitle);

        if (selectedTitle === "Í∞úÏù∏") {
            memberSelect.innerHTML = `<option value="ÎÇò">ÎÇò</option>`;
            return;
        }

        fetch(`http://localhost:8888/api/project-members?title=${selectedTitle}`, {
            method: "GET",
            credentials: "include"
        })
            .then((res) => res.json())
            .then((data) => {
                const creator = data.creator;
                const currentUser = data.currentUser;
                const members = data.members;

                memberSelect.innerHTML = "";

                if (creator === currentUser) {
                    memberSelect.innerHTML += `<option value="Í≥µÎèô">Í≥µÎèô</option>`;
                }

                memberSelect.innerHTML += `<option value="ÎÇò">ÎÇò</option>`;

                if (creator === currentUser) {
                    members.forEach((member) => {
                        if (member !== currentUser) {
                            memberSelect.innerHTML += `<option value="${member}">${member}</option>`;
                        }
                    });
                }
            })
            .catch((err) => {
                console.error("‚ùå ÌåÄÏõê Î™©Î°ù Î°úÎî© Ïã§Ìå®:", err);
            });
    });
});
