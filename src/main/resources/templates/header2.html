<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BOB ì‚¬ì´íŠ¸</title>
  <link rel="stylesheet" th:href="@{/css/header2.css}">
  <meta name="_csrf" content="${_csrf.token}" />
</head>
<body>
<!-- header -->
<div th:fragment="~{header2 :: header}"></div>

<header>
  <nav class="navigator">
    <div class="nav-left">
      <h3 class="site-name"><a href="/main">BOB</a></h3>
      <ul class="nav-list">
        <li class="nav-item">
          <a href="#" class="nav-menu">ê³µëª¨ì „</a>
          <div class="all-dropdown-menu">
            <div class="dropdown-section">
              <ul>
                <li><a href="comhome">ì „ì²´ ê³µëª¨ì „</a></li>
                <li><a href="/comcontest">ì£¼ìµœí•˜ê¸°</a></li>
                <li><a href="/comycontest">ì£¼ìµœí•œ ê³µëª¨ì „</a></li>
              </ul>
            </div>
          </div>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-menu">êµ¬ì¸</a>
          <div class="all-dropdown-menu">
            <div class="dropdown-section">
              <ul>
                <li><a href="/job2">êµ¬ì¸ ê³µê³ </a></li>
                <li><a href="/coportfoliozip">í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ìŒë°©</a></li>
                <li><a href="/cojobwrite">ê³µê³  ì‘ì„±í•˜ê¸°</a></li>
                <li><a href="/comyjob">ì‘ì„±í•œ ê³µê³  ë‚´ì—­</a></li>
                <li><a href="/corecruit">êµ¬ì¸ ë‚´ì—­</a></li>
              </ul>
            </div>
          </div>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-menu">ì´ë ¥ì„œ ì–‘ì‹</a>
          <div class="all-dropdown-menu">
            <div class="dropdown-section">
              <ul>
                <li><a href="/coresumelist">ì´ë ¥ì„œ ì–‘ì‹ ëª©ë¡</a> </li>
                <li><a href="/coresume">ì–‘ì‹ ìƒì„±í•˜ê¸°</a></li>
              </ul>
            </div>
          </div>
        </li>
      </ul>
    </div>
    <div class="nav-right">
      <div class="search-bar-container">
        <form id="searchForm">
          <input type="text" name="kw" id="search_kw" class="search-bar" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" th:value="${kw}">
          <span class="search-icon"><img src="/images/search.png" alt=""></span>
        </form>
      </div>

      <!-- ğŸ”¥ ì±„íŒ… ì•„ì´ì½˜ ì œê±°ë¨ -->

      <div class="nav-item1">
        <a class="user-icon">
          <img src="/images/user.png" alt="Profile Image">
        </a>
        <div class="all-dropdown-menu">
          <div class="dropdown-section">
            <ul>
              <li sec:authorize="isAuthenticated()"><a href="/profile2">ë‚´ ì •ë³´</a></li>
              <li sec:authorize="isAuthenticated()"><a href="#" class="notification-icon" id="notification-icon">ì•Œë¦¼</a><span class="notification-badge" id="notification-badge"></span></li>
              <li sec:authorize="isAuthenticated()"><a href="/costat">ì±„ìš© ê³µê³  í†µê³„</a></li>
              <li sec:authorize="isAuthenticated()">
                <form id="logoutForm" th:action="@{/logout}" method="post">
                  <button type="submit" class="logout">ë¡œê·¸ì•„ì›ƒ</button>
                </form>
              </li>
              <li sec:authorize="isAnonymous()"><a href="/login" id="plz"><img src="/images/login.png">ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- ğŸ“© ì•Œë¦¼ì°½ -->
  <form>
    <div class="notification-box" id="notification-box">
      <div class="notification-header">
        <h3>ì•Œë¦¼</h3>
        <button id="close-notification">&times;</button>
      </div>
      <ul id="notification-list">
        <!-- ì•Œë¦¼ ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
      </ul>
      <div class="notification-footer">
        <button id="clear-all">ëª¨ë‘ ì‚­ì œ</button>
      </div>
    </div>
  </form>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const notificationIcon = document.getElementById("notification-icon");
      const notificationBox = document.getElementById("notification-box");
      const closeNotification = document.getElementById("close-notification");
      const notificationList = document.getElementById("notification-list");
      const notificationBadge = document.getElementById("notification-badge");
      const clearAllButton = document.getElementById("clear-all");

      // âœ… ì•Œë¦¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
      fetchNotifications();

      // ğŸ”” ì•Œë¦¼ ëª©ë¡ ë Œë”ë§
      function renderNotifications(notifications) {
        notificationList.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

        if (!Array.isArray(notifications)) {
          console.error("âŒ ì•Œë¦¼ ëª©ë¡ ë°ì´í„°ê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:", notifications);
          notificationList.innerHTML = "<li class='notification-item'>ì•Œë¦¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>";
          return;
        }

        if (notifications.length === 0) {
          notificationList.innerHTML = "<li class='notification-item'>ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
          notificationBadge.style.display = "none"; // ì•Œë¦¼ ë°°ì§€ ìˆ¨ê¸°ê¸°
          return;
        }

        notifications.forEach(notification => {
          console.log("ğŸ“Œ ì•Œë¦¼ ë°ì´í„°:", notification); // âœ… ì•Œë¦¼ ë°ì´í„° í™•ì¸

          if (!notification.id) {
            console.error("âŒ ì•Œë¦¼ IDê°€ ì—†ìŠµë‹ˆë‹¤!", notification);
            return;
          }

          let item = document.createElement("li");
          item.classList.add("notification-item");
          item.textContent = notification.message;

          // âœ… ì•Œë¦¼ ID ë° í”„ë¡œì íŠ¸ IDë¥¼ data ì†ì„±ì— ì €ì¥
          item.setAttribute("data-id", notification.id);
          item.setAttribute("data-project-id", notification.projectId || "");
          item.setAttribute("data-user-id", notification.userId || "");

          // âœ… ì•Œë¦¼ í´ë¦­ ì‹œ ì½ìŒ ìƒíƒœë¡œ ì—…ë°ì´íŠ¸í•˜ê³  í˜ì´ì§€ ì´ë™
          item.onclick = function () {
            const notificationId = this.getAttribute("data-id");
            const projectId = this.getAttribute("data-project-id");
            const userId = this.getAttribute("data-user-id");

            console.log("ğŸ” í´ë¦­í•œ ì•Œë¦¼ ID:", notificationId);
            console.log("ğŸ” í´ë¦­í•œ í”„ë¡œì íŠ¸ ID:", projectId);
            console.log("ğŸ” í´ë¦­í•œ ì‚¬ìš©ì ID:", userId);

            if (!notificationId || notificationId === "undefined") {
              console.error("âŒ ì•Œë¦¼ IDê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!");
              return;
            }

            markAsRead(notificationId); // ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬

            // âœ… í”„ë¡œì íŠ¸ IDê°€ ìˆìœ¼ë©´ íŒ€ ì‹ ì²­ ìˆ˜ë½/ê±°ì ˆ í˜ì´ì§€ë¡œ ì´ë™
            if (projectId && projectId !== "undefined") {
              console.log("âœ… ì´ë™í•  í”„ë¡œì íŠ¸ ID:", projectId);
              window.location.href = `/teamrequest?projectId=${projectId}&userId=${userId}`;  // /teamrequestë¡œ ìˆ˜ì •
            } else if (notification.link && notification.link !== "undefined") {
              console.log("âœ… ì´ë™í•  ë§í¬:", notification.link);
              window.location.href = notification.link;
            } else {
              console.error("ğŸš¨ ì•Œë¦¼ ë§í¬ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }

          };


          notificationList.appendChild(item);
        });

        notificationBadge.style.display = "flex"; // ì•Œë¦¼ ë°°ì§€ ë³´ì´ê¸°
        notificationBadge.textContent = notifications.length; // ì•Œë¦¼ ê°œìˆ˜ í‘œì‹œ
      }

      // âœ… ì•Œë¦¼ ìˆ˜ ë° ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
      function fetchNotifications() {
        // ğŸ“Œ ì•Œë¦¼ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
        fetch("/api/notifications/count")
                .then(response => response.json())
                .then(data => {
                  console.log("ğŸ“¢ ì•Œë¦¼ ìˆ˜:", data); // âœ… ì•Œë¦¼ ìˆ˜ í™•ì¸
                  const notificationCount = data.notificationCount;

                  if (notificationCount > 0) {
                    notificationBadge.style.display = "flex"; // ë°°ì§€ ë³´ì´ê¸°
                    notificationBadge.textContent = notificationCount; // ì•Œë¦¼ ìˆ˜ í‘œì‹œ
                  } else {
                    notificationBadge.style.display = "none"; // ì•Œë¦¼ ìˆ˜ê°€ ì—†ìœ¼ë©´ ë°°ì§€ ìˆ¨ê¸°ê¸°
                  }
                })
                .catch(error => {
                  console.error("âŒ ì•Œë¦¼ ìˆ˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨", error);
                });

        // ğŸ“Œ ì•Œë¦¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        fetch("/api/notifications/list?page=0&size=10") // í˜ì´ì§€ë„¤ì´ì…˜ì„ ìœ„í•œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì¶”ê°€
                .then(response => response.json())
                .then(notifications => {
                  console.log("ğŸ“¢ ì•Œë¦¼ ëª©ë¡:", notifications); // âœ… ì•Œë¦¼ ëª©ë¡ í™•ì¸
                  renderNotifications(notifications); // ì•Œë¦¼ ëª©ë¡ ë Œë”ë§
                })
                .catch(error => {
                  console.error("âŒ ì•Œë¦¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨", error);
                });
      }

      // âœ… ì•Œë¦¼ì„ ì½ìŒ ìƒíƒœë¡œ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
      function markAsRead(notificationId) {
        console.log("ğŸ“¢ ì½ìŒ ì²˜ë¦¬ ìš”ì²­: ID =", notificationId);

        fetch(`/api/notifications/mark-as-read/${notificationId}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-TOKEN": getCsrfToken() // âœ… CSRF í† í° ì¶”ê°€
          }
        })
                .then(response => {
                  if (!response.ok) {
                    throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                  }
                  return response.json(); // âœ… JSON ì‘ë‹µì„ ë°˜í™˜í•˜ë„ë¡ ë³€ê²½
                })
                .then(data => {
                  console.log("âœ… ì•Œë¦¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ì„±ê³µ:", data);
                  fetchNotifications(); // ì•Œë¦¼ ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë Œë”ë§
                })
                .catch(error => console.error("âŒ ì•Œë¦¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨", error));
      }

      // âœ… CSRF í† í°ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
      function getCsrfToken() {
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute("content");
        if (!csrfToken) {
          console.error("âŒ CSRF í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
          return ""; // CSRF í† í°ì´ ì—†ì„ ê²½ìš° ë¹ˆ ë¬¸ìì—´ ë°˜í™˜
        }
        return csrfToken;
      }

      // ğŸ”¥ ì•Œë¦¼ ì•„ì´ì½˜ í´ë¦­ ì‹œ ì•Œë¦¼ì°½ í‘œì‹œ/ìˆ¨ê¹€
      notificationIcon.addEventListener("click", function () {
        notificationBox.style.display = (notificationBox.style.display === "none" || notificationBox.style.display === "") ? "flex" : "none";
      });

      // âŒ ì•Œë¦¼ì°½ ë‹«ê¸° ë²„íŠ¼
      closeNotification.addEventListener("click", function () {
        notificationBox.style.display = "none";
      });

      // ğŸ—‘ "ëª¨ë‘ ì‚­ì œ" ë²„íŠ¼
      clearAllButton.addEventListener("click", function () {
        notificationList.innerHTML = "<li class='notification-item'>ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>"; // âœ… UI ì—…ë°ì´íŠ¸
        notificationBadge.style.display = "none"; // âœ… ë°°ì§€ ìˆ¨ê¸°ê¸°
      });
    });
  </script>

</header>
</div>
x
</body>
</html>
