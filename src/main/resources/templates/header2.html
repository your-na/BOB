<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BOB 사이트</title>
  <link rel="stylesheet" th:href="@{/css/header2.css}">
  <meta name="_csrf" content="${_csrf.token}" />
</head>
<body>
<!-- header -->
<div th:fragment="~{header2 :: header}"></div>

<header>
  <nav class="navigator">
    <div class="nav-left">
      <h3 class="site-name"><a href="/main">BOB</a></h3>
      <ul class="nav-list">
        <li class="nav-item">
          <a href="#" class="nav-menu">공모전</a>
          <div class="all-dropdown-menu">
            <div class="dropdown-section">
              <ul>
                <li><a href="comhome">전체 공모전</a></li>
                <li><a href="/comcontest">주최하기</a></li>
                <li><a href="/comycontest">주최한 공모전</a></li>
              </ul>
            </div>
          </div>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-menu">구인</a>
          <div class="all-dropdown-menu">
            <div class="dropdown-section">
              <ul>
                <li><a href="/job2">구인 공고</a></li>
                <li><a href="/coportfoliozip">포트폴리오 모음방</a></li>
                <li><a href="/cojobwrite">공고 작성하기</a></li>
                <li><a href="/comyjob">작성한 공고 내역</a></li>
                <li><a href="/corecruit">구인 내역</a></li>
              </ul>
            </div>
          </div>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-menu">이력서 양식</a>
          <div class="all-dropdown-menu">
            <div class="dropdown-section">
              <ul>
                <li><a href="/coresumelist">이력서 양식 목록</a> </li>
                <li><a href="/coresume">양식 생성하기</a></li>
              </ul>
            </div>
          </div>
        </li>
      </ul>
    </div>
    <div class="nav-right">
      <div class="search-bar-container">
        <form id="searchForm">
          <input type="text" name="kw" id="search_kw" class="search-bar" placeholder="검색어 입력" th:value="${kw}">
          <span class="search-icon"><img src="/images/search.png" alt=""></span>
        </form>
      </div>

      <!-- 🔥 채팅 아이콘 제거됨 -->

      <div class="nav-item1">
        <a class="user-icon">
          <img src="/images/user.png" alt="Profile Image">
        </a>
        <div class="all-dropdown-menu">
          <div class="dropdown-section">
            <ul>
              <li sec:authorize="isAuthenticated()"><a href="/profile2">내 정보</a></li>
              <li sec:authorize="isAuthenticated()"><a href="#" class="notification-icon" id="notification-icon">알림</a><span class="notification-badge" id="notification-badge"></span></li>
              <li sec:authorize="isAuthenticated()"><a href="/costat">채용 공고 통계</a></li>
              <li sec:authorize="isAuthenticated()">
                <form id="logoutForm" th:action="@{/logout}" method="post">
                  <button type="submit" class="logout">로그아웃</button>
                </form>
              </li>
              <li sec:authorize="isAnonymous()"><a href="/login" id="plz"><img src="/images/login.png">로그인 해주세요</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- 📩 알림창 -->
  <form>
    <div class="notification-box" id="notification-box">
      <div class="notification-header">
        <h3>알림</h3>
        <button id="close-notification">&times;</button>
      </div>
      <ul id="notification-list">
        <!-- 알림 데이터가 여기에 동적으로 추가됨 -->
      </ul>
      <div class="notification-footer">
        <button id="clear-all">모두 삭제</button>
      </div>
    </div>
  </form>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const notificationIcon = document.getElementById("notification-icon");
      const notificationBox = document.getElementById("notification-box");
      const closeNotification = document.getElementById("close-notification");
      const notificationList = document.getElementById("notification-list");
      const notificationBadge = document.getElementById("notification-badge");
      const clearAllButton = document.getElementById("clear-all");

      // ✅ 알림 목록 불러오기
      fetchNotifications();

      // 🔔 알림 목록 렌더링
      function renderNotifications(notifications) {
        notificationList.innerHTML = ""; // 기존 목록 초기화

        if (!Array.isArray(notifications)) {
          console.error("❌ 알림 목록 데이터가 배열이 아닙니다:", notifications);
          notificationList.innerHTML = "<li class='notification-item'>알림 목록을 불러올 수 없습니다.</li>";
          return;
        }

        if (notifications.length === 0) {
          notificationList.innerHTML = "<li class='notification-item'>알림이 없습니다.</li>";
          notificationBadge.style.display = "none"; // 알림 배지 숨기기
          return;
        }

        notifications.forEach(notification => {
          console.log("📌 알림 데이터:", notification); // ✅ 알림 데이터 확인

          if (!notification.id) {
            console.error("❌ 알림 ID가 없습니다!", notification);
            return;
          }

          let item = document.createElement("li");
          item.classList.add("notification-item");
          item.textContent = notification.message;

          // ✅ 알림 ID 및 프로젝트 ID를 data 속성에 저장
          item.setAttribute("data-id", notification.id);
          item.setAttribute("data-project-id", notification.projectId || "");
          item.setAttribute("data-user-id", notification.userId || "");

          // ✅ 알림 클릭 시 읽음 상태로 업데이트하고 페이지 이동
          item.onclick = function () {
            const notificationId = this.getAttribute("data-id");
            const projectId = this.getAttribute("data-project-id");
            const userId = this.getAttribute("data-user-id");

            console.log("🔍 클릭한 알림 ID:", notificationId);
            console.log("🔍 클릭한 프로젝트 ID:", projectId);
            console.log("🔍 클릭한 사용자 ID:", userId);

            if (!notificationId || notificationId === "undefined") {
              console.error("❌ 알림 ID가 유효하지 않습니다!");
              return;
            }

            markAsRead(notificationId); // 알림 읽음 처리

            // ✅ 프로젝트 ID가 있으면 팀 신청 수락/거절 페이지로 이동
            if (projectId && projectId !== "undefined") {
              console.log("✅ 이동할 프로젝트 ID:", projectId);
              window.location.href = `/teamrequest?projectId=${projectId}&userId=${userId}`;  // /teamrequest로 수정
            } else if (notification.link && notification.link !== "undefined") {
              console.log("✅ 이동할 링크:", notification.link);
              window.location.href = notification.link;
            } else {
              console.error("🚨 알림 링크가 설정되지 않았습니다.");
            }

          };


          notificationList.appendChild(item);
        });

        notificationBadge.style.display = "flex"; // 알림 배지 보이기
        notificationBadge.textContent = notifications.length; // 알림 개수 표시
      }

      // ✅ 알림 수 및 목록을 가져오는 함수
      function fetchNotifications() {
        // 📌 알림 수 가져오기
        fetch("/api/notifications/count")
                .then(response => response.json())
                .then(data => {
                  console.log("📢 알림 수:", data); // ✅ 알림 수 확인
                  const notificationCount = data.notificationCount;

                  if (notificationCount > 0) {
                    notificationBadge.style.display = "flex"; // 배지 보이기
                    notificationBadge.textContent = notificationCount; // 알림 수 표시
                  } else {
                    notificationBadge.style.display = "none"; // 알림 수가 없으면 배지 숨기기
                  }
                })
                .catch(error => {
                  console.error("❌ 알림 수 가져오기 실패", error);
                });

        // 📌 알림 목록 가져오기
        fetch("/api/notifications/list?page=0&size=10") // 페이지네이션을 위한 쿼리 파라미터 추가
                .then(response => response.json())
                .then(notifications => {
                  console.log("📢 알림 목록:", notifications); // ✅ 알림 목록 확인
                  renderNotifications(notifications); // 알림 목록 렌더링
                })
                .catch(error => {
                  console.error("❌ 알림 목록 가져오기 실패", error);
                });
      }

      // ✅ 알림을 읽음 상태로 처리하는 함수
      function markAsRead(notificationId) {
        console.log("📢 읽음 처리 요청: ID =", notificationId);

        fetch(`/api/notifications/mark-as-read/${notificationId}`, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-TOKEN": getCsrfToken() // ✅ CSRF 토큰 추가
          }
        })
                .then(response => {
                  if (!response.ok) {
                    throw new Error(`서버 오류: ${response.status}`);
                  }
                  return response.json(); // ✅ JSON 응답을 반환하도록 변경
                })
                .then(data => {
                  console.log("✅ 알림 상태 업데이트 성공:", data);
                  fetchNotifications(); // 알림 리스트 다시 렌더링
                })
                .catch(error => console.error("❌ 알림 상태 업데이트 실패", error));
      }

      // ✅ CSRF 토큰을 가져오는 함수
      function getCsrfToken() {
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute("content");
        if (!csrfToken) {
          console.error("❌ CSRF 토큰을 찾을 수 없습니다!");
          return ""; // CSRF 토큰이 없을 경우 빈 문자열 반환
        }
        return csrfToken;
      }

      // 🔥 알림 아이콘 클릭 시 알림창 표시/숨김
      notificationIcon.addEventListener("click", function () {
        notificationBox.style.display = (notificationBox.style.display === "none" || notificationBox.style.display === "") ? "flex" : "none";
      });

      // ❌ 알림창 닫기 버튼
      closeNotification.addEventListener("click", function () {
        notificationBox.style.display = "none";
      });

      // 🗑 "모두 삭제" 버튼
      clearAllButton.addEventListener("click", function () {
        notificationList.innerHTML = "<li class='notification-item'>알림이 없습니다.</li>"; // ✅ UI 업데이트
        notificationBadge.style.display = "none"; // ✅ 배지 숨기기
      });
    });
  </script>

</header>
</div>
x
</body>
</html>
