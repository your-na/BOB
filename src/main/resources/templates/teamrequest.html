<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ν€ μ°Έκ°€ μ‹ μ²­</title>

  <!-- β… CSRF ν† ν°μ„ HTMLμ— μ¶”κ°€ -->
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

  <link rel="stylesheet" href="/css/teamrequest.css">
  <link rel="stylesheet" th:href="@{/css/header.css}">
</head>

<body>
<!-- header -->
<div th:insert="~{header :: header}"></div>

<!-- β… ν”„λ΅μ νΈ IDμ™€ μ μ € IDλ¥Ό Thymeleafλ¥Ό μ΄μ©ν•΄ data μ†μ„±μΌλ΅ μ €μ¥ -->
<div class="request-container"
     th:data-project-id="${projectId}"
     th:data-user-id="${userId != null ? userId : ''}">  <!-- β… userIdκ°€ nullμ΄λ©΄ λΉ λ¬Έμμ—΄λ΅ μ„¤μ • -->

  <p class="request-message">
    <strong th:text="${userNick}"></strong>λ‹κ»μ„
    '<strong th:text="${projectTitle}"></strong>' ν€ μ°Έκ°€λ¥Ό μ‹ μ²­ν•μ…¨μµλ‹λ‹¤.
    <br>
    <a th:href="@{'/postproject/' + ${projectId}}">ν•΄λ‹Ή κ²μ‹κΈ€ λ³΄κΈ° &gt;</a>
  </p>

  <div class="profile-section">
    <img src="/images/profile.png" alt="ν”„λ΅ν•„ μ‚¬μ§„" class="profile-image">
    <p class="user-name" th:text="${userNick}">μ‚¬μ©μ μ΄λ¦„</p>
    <button type="button" class="view-application">μ‹ μ²­μ„ λ³΄κΈ°</button>
  </div>

  <div class="action-buttons">
    <!-- β… λ²„νΌ ν΄λ¦­ μ‹ API νΈμ¶ -->
    <button type="button" class="accept-btn">μλ½</button>
    <button type="button" class="reject-btn">κ±°μ </button>
  </div>
</div>

<script>
  function getCsrfToken() {
    let metaToken = document.querySelector("meta[name='_csrf']");
    if (metaToken) {
      return metaToken.getAttribute("content");
    }

    let csrfMatch = document.cookie.match(new RegExp('(^| )XSRF-TOKEN=([^;]+)'));
    return csrfMatch ? csrfMatch[2] : '';
  }

  window.addEventListener("load", function() {
    const requestContainer = document.querySelector(".request-container");

    const projectId = requestContainer.getAttribute("data-project-id");
    let userId = requestContainer.getAttribute("data-user-id");

    console.log("β… [DEBUG] Project ID:", projectId);
    console.log("β… [DEBUG] User ID:", userId);

    if (!userId || userId === "null" || userId.trim() === "") {
      alert("β μ¤λ¥: User IDκ°€ μ ν¨ν•μ§€ μ•μµλ‹λ‹¤.");
      return;
    }

    userId = parseInt(userId);
    if (isNaN(userId) || userId === 0) {
      alert("β μ¤λ¥: μ¬λ°”λ¥Έ μ‚¬μ©μ IDκ°€ μ•„λ‹™λ‹λ‹¤.");
      return;
    }

    const csrfToken = getCsrfToken();
    console.log("β… [DEBUG] CSRF Token:", csrfToken);

    const acceptButton = document.querySelector(".accept-btn");
    if (acceptButton) {
      acceptButton.addEventListener("click", function() {
        fetch("http://localhost:8888/teamrequest/accept", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-TOKEN": csrfToken
          },
          credentials: "include",
          body: JSON.stringify({
            projectId: projectId,
            userId: userId
          })
        })
                .then(response => {
                  if (!response.ok) {
                    return response.text().then(errorMessage => {
                      throw new Error(`β μ¤λ¥ λ°μƒ (${response.status}): ${errorMessage}`);
                    });
                  }
                  return response.text();
                })
                .then(data => {
                  alert("β… ν€μ› μ‹ μ²­μ΄ μΉμΈλμ—μµλ‹λ‹¤!");
                  window.location.href = "/main"; // β… λ©”μΈνμ΄μ§€λ΅ μ΄λ™
                })
                .catch(error => {
                  alert("β μ”μ²­ μ‹¤ν¨: " + error.message);
                });
      });
    }

    const rejectButton = document.querySelector(".reject-btn");
    if (rejectButton) {
      rejectButton.addEventListener("click", function() {
        fetch("http://localhost:8888/teamrequest/reject", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-XSRF-TOKEN": getCsrfToken()
          },
          credentials: "include",
          body: JSON.stringify({
            projectId: projectId,
            userId: userId
          })
        })
                .then(response => {
                  if (!response.ok) {
                    return response.text().then(errorMessage => {
                      throw new Error(`β μ¤λ¥ λ°μƒ (${response.status}): ${errorMessage}`);
                    });
                  }
                  return response.text();
                })
                .then(data => {
                  alert("π« " + data);
                  window.location.href = "/main"; // β… λ©”μΈνμ΄μ§€λ΅ μ΄λ™
                })
                .catch(error => {
                  alert("β μ”μ²­ μ‹¤ν¨: " + error.message);
                });
      });
    }
  });
</script>

</body>
</html>
