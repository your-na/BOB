<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title th:text="${project.title}">프로젝트 상세보기</title>

    <!-- ✅ CSRF 토큰 추가 (보안 인증) -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <link rel="stylesheet" href="/css/postproject.css">
    <link rel="stylesheet" th:href="@{/css/header.css}">
</head>

<body>
<!-- header -->
<div th:insert="~{header :: header}"></div>

<!-- 제목과 모집현황 -->
<div class="title-row">
    <div class="title" th:text="${project.title}">프로젝트 제목</div>
    <span class="deadline" th:text="'D-' + ${project.recruitmentPeriod}">D-14</span>
    <div class="status">
        모집현황
        <div class="team">
            <div id="yes"><img src="/images/team.png"></div>
            <div id="no"><img src="/images/user.png"><img src="/images/user.png"><img src="/images/user.png"></div>
        </div>
    </div>
    <div class="post-detail">
        <img class="postdetail" src="/images/postdetail.png" alt="점 세 개" onclick="toggleDropdown()">
        <div class="dropdownmenu" id="dropdownMenu" style="display: none;">
            <a class="action-button" th:href="@{'/postproject/' + ${project.id} + '/edit'}">수정하기</a>
            <a class="action-button" href="javascript:void(0);" onclick="deleteProject()">삭제하기</a>
        </div>
    </div>
</div>
<hr>

<!-- 작성자 및 작성일 -->
<div class="meta">
    <span class="meta1" th:text="${project.createdBy}">작성자</span>
    <span class="meta2" th:text="'작성일 : ' + ${today}">작성일</span>
</div>

<div class="form-group">
    <label for="project-dates">진행 일정</label>
    <div class="date-inputs">
        <span id="start-date" th:text="${project.startDate}"></span>
        <span>~</span>
        <span id="end-date" th:text="${project.endDate}"></span>
    </div>
</div>

<div class="form-group">
    <label for="party-dates">모집 일정</label>
    <div class="date-inputs">
        <span id="startdate" th:text="${project.recruitmentStartDate}"></span>
        <span>~</span>
        <span id="enddate" th:text="${project.recruitmentEndDate}"></span>
    </div>
</div>

<!--프로젝트 목표-->
<div class="good">
    <p>프로젝트 목표</p>
    <div class="goal">
        <span th:text="${goal}">여기에 프로젝트 목표가 들어갑니다.</span>
    </div>
</div>

<!-- 프로젝트 설명 -->
<div class="good">
    <p>프로젝트 내용</p>
    <div class="content" th:text="${project.description}">
        프로젝트 설명 내용
    </div>
</div>

<!-- 팀 신청 버튼 -->
<form>
    <button class="apply-btn">팀 신청하기</button>
</form>

<hr>
<!-- 좋아요 & 스크랩 -->
<div class="interaction">
    <div id="heart" onclick="toggleHeart()">
        <img id="heartImage" src="/images/heart.png"> <!-- 빈 하트 이미지로 시작 -->
        <span id="likesCount">0</span> <!-- 좋아요 수 표시 -->
    </div>
    <div id="scrap"><img src="/images/scrap.png"> <span>0</span></div>
</div>

<!-- 댓글 입력 -->
<form>
    <input type="text" class="comment-box" placeholder="댓글을 작성해주세요.">
    <button class="postbutton">등록</button>
</form>

<script>
    // ✅ 드롭다운 토글 기능 (초기 숨김 처리)
    function toggleDropdown() {
        var dropdown = document.getElementById("dropdownMenu");
        dropdown.style.display = (dropdown.style.display === "none" || dropdown.style.display === "") ? "block" : "none";
    }

    // ✅ 프로젝트 삭제 함수 (삭제 기능만 수정)
    function deleteProject() {
        let projectId = window.location.pathname.split("/")[2];

        if (!confirm("⚠️ 정말 삭제하시겠습니까? 삭제 후 복구할 수 없습니다!")) {
            return;
        }

        // ✅ CSRF 토큰 가져오기
        let csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        let csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

        if (!csrfToken || !csrfHeader) {
            alert("❌ CSRF 토큰을 찾을 수 없습니다. 다시 시도해주세요.");
            return;
        }

        fetch(`/postproject/${projectId}/delete`, {
            method: "DELETE",  // ✅ DELETE 메서드로 변경
            headers: {
                [csrfHeader]: csrfToken  // ✅ CSRF 헤더 추가
            }
        })
            .then(response => {
                if (response.ok) {
                    alert("✅ 프로젝트가 삭제되었습니다.");
                    window.location.href = "/project";
                } else {
                    return response.text().then(text => {
                        console.error("❌ 서버 응답:", text);
                        alert("❌ 프로젝트 삭제에 실패했습니다.");
                    });
                }
            })
            .catch(error => {
                console.error("❌ 삭제 요청 실패:", error);
                alert("❌ 프로젝트 삭제 중 오류 발생");
            });
    }

    // ✅ 페이지 로드 시 드롭다운 메뉴 숨기기
    document.addEventListener("DOMContentLoaded", function() {
        var dropdown = document.getElementById("dropdownMenu");
        if (dropdown) {
            dropdown.style.display = "none"; // 기본적으로 숨기기
        }
    });
</script>

</body>
</html>
