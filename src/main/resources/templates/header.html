<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOB ì‚¬ì´íŠ¸</title>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <!-- CSRF í† í°ì„ ìœ„í•œ meta íƒœê·¸ ì¶”ê°€ (ì¤‘ë³µ ì œê±°) -->
    <meta name="_csrf" content="${_csrf.token}" />
</head>
<body>
<!-- header -->
<div th:fragment="~{header :: header}"></div>

<header>
    <nav class="navigator">
        <div class="nav-left">
            <h3 class="site-name"><a href="/main">BOB</a></h3>
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="#" class="nav-menu">ê³µëª¨ì „</a>
                    <div class="all-dropdown-menu">
                        <div class="dropdown-section">
                            <ul>
                                <li><a href="contest">ì „ì²´ ê³µëª¨ì „</a></li>
                                <li><a th:href="@{/contestact}">ê³µëª¨ì „ í™œë™</a></li>
                                <li><a th:href="@{/likedcontest}">ì°œí•œ ê³µëª¨ì „</a></li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-menu">í”„ë¡œì íŠ¸</a>
                    <div class="all-dropdown-menu">
                        <div class="dropdown-section">
                            <ul>
                                <li><a th:href="@{/project}">í”„ë¡œì íŠ¸</a></li>
                                <li><a href="newproject">í”„ë¡œì íŠ¸ ìƒì„±</a></li>
                                <li><a href="myproject">MY í”„ë¡œì íŠ¸</a></li>
                                <li><a href="#">ì°œí•œ í”„ë¡œì íŠ¸</a></li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-menu">êµ¬ì§</a>
                    <div class="all-dropdown-menu">
                        <div class="dropdown-section">
                            <ul>
                                <li><a href="#">êµ¬ì¸ ê³µê³ </a></li>
                                <li><a href="#">í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ìŒë°©</a></li>
                                <li><a href="#">ì‹ ì²­í•œ êµ¬ì§ ë‚´ì—­</a></li>
                                <li><a href="#">ì°œí•œ ê³µê³ </a></li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-menu">ì´ë ¥ì„œ</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-menu">ê²Œì‹œíŒ</a>
                </li>
            </ul>
        </div>
        <div class="nav-right">
            <div class="search-bar-container">
                <form id="searchForm">
                    <input type="text" name="kw" id="search_kw" class="search-bar" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" th:value="${kw}">
                    <span class="search-icon"><img src="/images/search.png" alt=""></span>
                </form>
            </div>
            <a class="chatting-icon">
                <img src="/images/chatting.png" alt="">
            </a>
            <div class="nav-item1">
                <a class="user-icon">
                    <img src="/images/user.png" alt="Profile Image">
                </a>
                <div class="all-dropdown-menu">
                    <div class="dropdown-section">
                        <ul>
                            <!-- ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ -->
                            <li th:if="${user != null}"><a href="/profile">ë‚´ ì •ë³´ / í‰ì </a></li>
                            <li th:if="${user != null}"><a href="#" class="notification-icon" id="notification-icon">ì•Œë¦¼</a><span class="notification-badge" id="notification-badge"></span></li>
                            <li th:if="${user != null}"><a th:href="@{/history}">ê²½ë ¥ ë‚´ì—­</a></li>
                            <li th:if="${user != null}"><a th:href="@{/appstatus}">ì§€ì› í˜„í™©</a></li>
                            <li th:if="${user != null}">
                                <form id="logoutForm" th:action="@{/logout}" method="post">
                                    <button type="submit" class="logout">ë¡œê·¸ì•„ì›ƒ</button>
                                </form>
                            </li>

                            <!-- ë¹„ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ -->
                            <li th:unless="${user != null}"><a href="/login" id="plz"><img src="/images/login.png">ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- ğŸ“© ì•Œë¦¼ì°½ -->
    <form>
        <div class="notification-box" id="notification-box">
            <div class="notification-header">
                <h3>ì•Œë¦¼</h3>
                <button id="close-notification">&times;</button>
            </div>
            <ul id="notification-list">
                <!-- ì•Œë¦¼ ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
            </ul>
            <div class="notification-footer">
                <button id="clear-all">ëª¨ë‘ ì‚­ì œ</button>
            </div>
        </div>
    </form>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const notificationIcon = document.getElementById("notification-icon");
            const notificationBox = document.getElementById("notification-box");
            const closeNotification = document.getElementById("close-notification");
            const notificationList = document.getElementById("notification-list");
            const notificationBadge = document.getElementById("notification-badge");
            const clearAllButton = document.getElementById("clear-all");

            // ì•Œë¦¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            fetchNotifications();

            // ì•Œë¦¼ ëª©ë¡ ë Œë”ë§
            function renderNotifications(notifications) {
                notificationList.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

                if (!Array.isArray(notifications)) {
                    console.error("ì•Œë¦¼ ëª©ë¡ ë°ì´í„°ê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:", notifications);
                    notificationList.innerHTML = "<li class='notification-item'>ì•Œë¦¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>";
                    return;
                }

                if (notifications.length === 0) {
                    notificationList.innerHTML = "<li class='notification-item'>ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
                    notificationBadge.style.display = "none"; // ì•Œë¦¼ ë°°ì§€ ìˆ¨ê¸°ê¸°
                    return;
                }

                notifications.forEach(notification => {
                    let item = document.createElement("li");
                    item.classList.add("notification-item");
                    item.textContent = notification.message;

                    // ì•Œë¦¼ ID ë° í”„ë¡œì íŠ¸ IDë¥¼ data ì†ì„±ì— ì €ì¥
                    item.setAttribute("data-id", notification.id);
                    item.setAttribute("data-project-id", notification.projectId || "");
                    item.setAttribute("data-user-id", notification.userId || "");

                    // ì•Œë¦¼ í´ë¦­ ì‹œ ì½ìŒ ìƒíƒœë¡œ ì—…ë°ì´íŠ¸í•˜ê³  í˜ì´ì§€ ì´ë™
                    item.onclick = function () {
                        const notificationId = this.getAttribute("data-id");
                        const projectId = this.getAttribute("data-project-id");
                        const userId = this.getAttribute("data-user-id");

                        if (!notificationId || notificationId === "undefined") {
                            console.error("ì•Œë¦¼ IDê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!");
                            return;
                        }

                        markAsRead(notificationId); // ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬

                        // í”„ë¡œì íŠ¸ IDê°€ ìˆìœ¼ë©´ íŒ€ ì‹ ì²­ ìˆ˜ë½/ê±°ì ˆ í˜ì´ì§€ë¡œ ì´ë™
                        if (projectId && projectId !== "undefined") {
                            window.location.href = `/teamrequest?projectId=${projectId}&userId=${userId}`;
                        } else if (notification.link && notification.link !== "undefined") {
                            window.location.href = notification.link;
                        } else {
                            console.error("ì•Œë¦¼ ë§í¬ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                        }
                    };

                    notificationList.appendChild(item);
                });

                notificationBadge.style.display = "flex"; // ì•Œë¦¼ ë°°ì§€ ë³´ì´ê¸°
                notificationBadge.textContent = notifications.length; // ì•Œë¦¼ ê°œìˆ˜ í‘œì‹œ
            }

            // ì•Œë¦¼ ìˆ˜ ë° ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
            function fetchNotifications() {
                // ì•Œë¦¼ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
                fetch("/api/notifications/count")
                    .then(response => response.json())
                    .then(data => {
                        const notificationCount = data.notificationCount;

                        if (notificationCount > 0) {
                            notificationBadge.style.display = "flex"; // ë°°ì§€ ë³´ì´ê¸°
                            notificationBadge.textContent = notificationCount; // ì•Œë¦¼ ìˆ˜ í‘œì‹œ
                        } else {
                            notificationBadge.style.display = "none"; // ì•Œë¦¼ ìˆ˜ê°€ ì—†ìœ¼ë©´ ë°°ì§€ ìˆ¨ê¸°ê¸°
                        }
                    })
                    .catch(error => {
                        console.error("ì•Œë¦¼ ìˆ˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨", error);
                    });

                // ì•Œë¦¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                fetch("/api/notifications/list?page=0&size=10") // í˜ì´ì§€ë„¤ì´ì…˜ì„ ìœ„í•œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì¶”ê°€
                    .then(response => response.json())
                    .then(notifications => {
                        renderNotifications(notifications); // ì•Œë¦¼ ëª©ë¡ ë Œë”ë§
                    })
                    .catch(error => {
                        console.error("ì•Œë¦¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨", error);
                    });
            }

            // ì•Œë¦¼ì„ ì½ìŒ ìƒíƒœë¡œ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
            function markAsRead(notificationId) {
                fetch(`/api/notifications/mark-as-read/${notificationId}`, {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRF-TOKEN": getCsrfToken() // CSRF í† í° ì¶”ê°€
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        fetchNotifications(); // ì•Œë¦¼ ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë Œë”ë§
                    })
                    .catch(error => console.error("ì•Œë¦¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨", error));
            }

            // CSRF í† í°ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
            function getCsrfToken() {
                const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute("content");
                return csrfToken ? csrfToken : ''; // CSRF í† í°ì´ ì—†ì„ ê²½ìš° ë¹ˆ ë¬¸ìì—´ ë°˜í™˜
            }

            // ì•Œë¦¼ ì•„ì´ì½˜ í´ë¦­ ì‹œ ì•Œë¦¼ì°½ í‘œì‹œ/ìˆ¨ê¹€
            notificationIcon.addEventListener("click", function () {
                notificationBox.style.display = (notificationBox.style.display === "none" || notificationBox.style.display === "") ? "flex" : "none";
            });

            // ì•Œë¦¼ì°½ ë‹«ê¸° ë²„íŠ¼
            closeNotification.addEventListener("click", function () {
                notificationBox.style.display = "none";
            });

            // "ëª¨ë‘ ì‚­ì œ" ë²„íŠ¼
            clearAllButton.addEventListener("click", function () {
                fetch("/api/notifications/delete-all", {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRF-TOKEN": getCsrfToken() // CSRF í† í° ì¶”ê°€
                    },
                    credentials: "include"  // ì¿ í‚¤ì™€ ì„¸ì…˜ì„ í¬í•¨í•˜ì—¬ ìš”ì²­
                })
                    .then(response => {
                        if (!response.ok) {
                            // ì‘ë‹µì´ ì„±ê³µì ì´ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬
                            return response.text().then(errorMessage => {
                                throw new Error(`ì•Œë¦¼ ì‚­ì œ ì‹¤íŒ¨: ${errorMessage}`);
                            });
                        }
                        return response.text(); // ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ë©´ ì„œë²„ ì‘ë‹µì„ ë°˜í™˜
                    })
                    .then(data => {
                        alert("ëª¨ë“  ì•Œë¦¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        notificationList.innerHTML = "<li class='notification-item'>ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>"; // UI ì—…ë°ì´íŠ¸
                        notificationBadge.style.display = "none"; // ë°°ì§€ ìˆ¨ê¸°ê¸°
                    })
                
            });

        });
    </script>
</header>
</div>
x
</body>
</html>
