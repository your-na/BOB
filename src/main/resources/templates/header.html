<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOB 사이트</title>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <!-- CSRF 토큰을 위한 meta 태그 추가 (중복 제거) -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

</head>
<body>
<!-- header -->
<div th:fragment="~{header :: header}"></div>

<header>
    <nav class="navigator">
        <div class="nav-left">
            <h3 class="site-name"><a href="/main">BOB</a></h3>
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="#" class="nav-menu">공모전</a>
                    <div class="all-dropdown-menu">
                        <div class="dropdown-section">
                            <ul>
                                <li><a th:href="@{/contest}">전체 공모전</a></li>
                                <li><a th:href="@{/contestact}">공모전 활동</a></li>
                                <li><a th:href="@{/likedcontest}">찜한 공모전</a></li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-menu">프로젝트</a>
                    <div class="all-dropdown-menu">
                        <div class="dropdown-section">
                            <ul>
                                <li><a th:href="@{/project}">프로젝트</a></li>
                                <li><a th:href="@{/newproject}">프로젝트 생성</a></li>
                                <li><a th:href="@{/myproject}">MY 프로젝트</a></li>
                                <li><a href="#">찜한 프로젝트</a></li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-menu">구직</a>
                    <div class="all-dropdown-menu">
                        <div class="dropdown-section">
                            <ul>
                                <li><a th:href="@{/job}">구인 공고</a></li>
                                <li><a th:href="@{/portfoliozip}">포트폴리오 모음방</a></li>
                                <li><a th:href="@{/jobapplication}">신청한 구직 내역</a></li>
                                <li><a href="#">찜한 공고</a></li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-menu">이력서</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-menu">게시판</a>
                </li>
            </ul>
        </div>
        <div class="nav-right">
            <div class="search-bar-container">
                <form id="searchForm" action="/search" method="get">
                    <input type="text" name="kw" id="search_kw" class="search-bar" placeholder="검색어 입력" th:value="${kw}">
                    <span class="search-icon"><img src="/images/search.png" alt=""></span>
                </form>
            </div>
            <a class="chatting-icon" onclick="openChatWindow()">
                <img src="/images/chatting.png" alt="">
            </a>
            <div class="nav-item1">
                <a class="user-icon">
                    <!-- 로그인 안 한 사용자만 아이콘 표시 -->
                    <img src="/images/user.png" alt="Profile Image" sec:authorize="isAnonymous()" />

                    <!-- 로그인한 사용자에게만 프로필과 닉네임 표시 -->
                    <div class="user-profile" sec:authorize="isAuthenticated()">
                        <img class="user-avatar" th:src="${#authentication.principal.userEntity.profileImageUrl}" alt="프로필 이미지">
                        <span class="user-nick" th:text="${#authentication.principal.userEntity.userNick}">닉네임</span>
                    </div>

                </a>
                <div class="all-dropdown-menu">
                    <div class="dropdown-section">
                        <ul>
                            <!-- 로그인 상태일 때 -->
                            <li sec:authorize="isAuthenticated()"><a href="/profile">내 정보 / 평점</a></li>
                            <li sec:authorize="isAuthenticated()"><a href="#" class="notification-icon" id="notification-icon">알림</a><span class="notification-badge" id="notification-badge"></span></li>
                            <li sec:authorize="isAuthenticated()"><a th:href="@{/history}">경력 내역</a></li>
                            <li sec:authorize="isAuthenticated()"><a th:href="@{/appstatus}">지원 현황</a></li>
                            <li sec:authorize="isAuthenticated()">
                                <form id="logoutForm" th:action="@{/logout}" method="post">
                                    <button type="submit" class="logout">로그아웃</button>
                                </form>
                            </li>

                            <!-- 비로그인 상태일 때 -->
                            <li sec:authorize="isAnonymous()"><a href="/login" id="plz"><img src="/images/login.png">로그인 해주세요</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 📩 알림창 -->
    <form>
        <div class="notification-box" id="notification-box">
            <div class="notification-header">
                <h3>알림</h3>
                <button id="close-notification">&times;</button>
            </div>
            <ul id="notification-list">
                <!-- 알림 데이터가 여기에 동적으로 추가됨 -->
            </ul>
            <div class="notification-footer">
                <button id="clear-all">모두 삭제</button>
            </div>
        </div>
    </form>

    <!-- 공모전 친구랑 참여하기 모달 -->
    <div id="inviteDecisionModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeInviteModal()">&times;</span>
            <h3>팀 초대</h3>
            <p id="invite-text">[닉네임]님이 '[팀명]' 팀에 초대했습니다.</p>

            <!-- 공모전 공고 보기 버튼 추가 -->
            <button id="view-contest-btn" class="view-contest-btn">
                📄 공모전 공고 보기
            </button>

            <div class="modal-buttons">
                <button id="accept-btn">수락</button>
                <button id="reject-btn">거절</button>
            </div>
        </div>
    </div>

    <!-- 공모전 팀 신청 알림 모달 -->
    <div id="applyTeamModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeApplyModal()">&times;</span>
            <h3>팀 신청 요청</h3>
            <p id="apply-text">[닉네임]님이 '[팀명]' 팀에 참가 신청을 보냈습니다.</p>

            <!-- 공모전 및 프로젝트 참여 내역 보기 보기 버튼 추가 -->
            <button id="view-activity-btn" class="view-contest-btn">
                📄 공모전 및 프로젝트 참여 내역 보기
            </button>

            <div class="modal-buttons">
                <button id="approve-application-btn">수락</button>
                <button id="deny-application-btn">거절</button>
            </div>
        </div>
    </div>



    <!-- ✅ 채용 축하 모달 -->
    <div id="hireModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeHireModal()">&times;</span>
            <h2>🎉 합격 축하드립니다!</h2>
            <p id="hire-company" style="font-weight: bold; font-size: 18px;"></p>
            <p id="hire-message">기업의 채용 메시지가 여기에 들어갑니다.</p>

            <div class="modal-buttons">
                <button onclick="closeHireModal()">확인</button>
                <a id="hire-detail-btn" href="#" target="_blank" class="view-contest-btn">자세히 보기</a>
            </div>
        </div>
    </div>

    <!-- ❎ 불합격 안내 모달 -->
    <div id="rejectModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeRejectModal()">&times;</span>
            <h2>❎ 불합격 안내</h2>
            <p id="reject-company" style="font-weight: bold; font-size: 18px;"></p>
            <p>안타깝지만 이번 채용에서는 함께하지 않게 되었습니다.</p>

            <div class="modal-buttons">
                <button onclick="closeRejectModal()">확인</button>
                <a id="reject-detail-btn" href="#" target="_blank" class="view-contest-btn">공고 보기</a>
            </div>
        </div>
    </div>



    <script>
        function getCsrf() {
            const token = document.querySelector('meta[name="_csrf"]')?.getAttribute("content");
            const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute("content");
            return { header, token };
        }

        function deleteNotification(notificationId) {
            const { header: csrfHeader, token: csrfToken } = getCsrf();

            fetch(`/api/notifications/delete/${notificationId}`, {
                method: 'DELETE',
                headers: {
                    [csrfHeader]: csrfToken
                },
                credentials: 'include'
            }).then(() => {
                fetchNotifications(); // 목록 새로고침
            }).catch(err => {
                console.error("알림 삭제 실패:", err);
            });
        }

        function fetchNotifications() {
            fetch("/api/notifications/count")
                .then(response => response.json())
                .then(data => {
                    const notificationCount = data.notificationsCount;

                    if (notificationCount > 0) {
                        notificationBadge.style.display = "flex";
                        notificationBadge.textContent = notificationCount;
                    } else {
                        notificationBadge.style.display = "none";
                    }
                })
                .catch(error => {
                    console.error("알림 수 가져오기 실패", error);
                });

            fetch("/api/notifications/list?page=0&size=10")
                .then(response => response.json())
                .then(notifications => {
                    renderNotifications(notifications);
                })
                .catch(error => {
                    console.error("알림 목록 가져오기 실패", error);
                });
        }

        let notificationBadge;
        let notificationList;
        let notificationIcon;

        function renderNotifications(notifications) {
            notificationList.innerHTML = "";

            if (!Array.isArray(notifications)) {
                console.error("알림 목록 데이터가 배열이 아닙니다:", notifications);
                notificationList.innerHTML = "<li class='notification-item'>알림 목록을 불러올 수 없습니다.</li>";
                return;
            }

            if (notifications.length === 0) {
                notificationList.innerHTML = "<li class='notification-item'>알림이 없습니다.</li>";
                notificationBadge.style.display = "none";
                return;
            }

            notifications.forEach(notification => {
                let item = document.createElement("li");
                item.classList.add("notification-item");
                // ✅ 채용 알림이면 기업명 기반 동적 메시지, 아니면 원래 메시지
                if (notification.type === 'HIRE_NOTICE' && notification.companyName) {
                    item.textContent = `📩 ${notification.companyName}에서 채용 알림이 도착했어요!`;
                } else {
                    item.textContent = notification.message;
                }


                item.setAttribute("data-id", notification.id);
                item.setAttribute("data-project-id", notification.projectId || "");
                item.setAttribute("data-user-id", notification.userId || "");

                const currentNotification = { ...notification };

                item.onclick = function (event) {
                    const notificationId = this.getAttribute("data-id");
                    const projectId = this.getAttribute("data-project-id");
                    const userId = this.getAttribute("data-user-id");
                    const contestId = currentNotification.contestId;

                    markAsRead(notificationId);

                    console.log("클릭된 알림:", currentNotification);
                    console.log("타입:", currentNotification.type);

                    if (currentNotification.type === 'CONTEST_INVITE') {
                        event.preventDefault();
                        event.stopPropagation();

                        const teamId = currentNotification.teamId;
                        const teamName = currentNotification.teamName;

                        fetch(`/contest/team/api/team/member-id?teamId=${teamId}`)
                            .then(res => res.json())
                            .then(data => {
                                const inviteId = data.inviteId;
                                openInviteModal(inviteId, teamName, teamId, contestId);
                            })
                            .catch(err => {
                                console.error("초대 정보 조회 실패:", err);
                                alert("초대 정보를 불러올 수 없습니다.");
                            });

                        return;
                    }

                    if (currentNotification.type === 'HIRE_NOTICE') {
                        // 💡 불합격 고정 메시지로 분기
                        if (currentNotification.message === "아쉽게도 이번에는 함께하지 못하게 되었습니다.") {
                            openRejectModal(currentNotification.companyName, currentNotification.jobPostId);
                        } else {
                            openHireModal(currentNotification.companyName, currentNotification.message, currentNotification.jobPostId);
                        }
                        return;
                    }

                    if (currentNotification.type === 'CONTEST_APPLICATION') {
                        event.preventDefault();
                        event.stopPropagation();

                        const teamName = currentNotification.teamName;
                        const applicantNick = currentNotification.senderNick;
                        const applicationId = currentNotification.applicationId;

                        openApplyModal(applicationId, teamName, applicantNick);
                        return;
                    }

                    if (projectId && userId && projectId !== "undefined" && userId !== "undefined") {
                        window.location.href = `/teamrequest/${projectId}/${userId}`; // ✅ 올바른 URL 패턴!
                    }
                    else if (notification.link && notification.link !== "undefined") {
                        window.location.href = currentNotification.link;
                    } else {
                        console.error("알림 링크가 설정되지 않았습니다.");
                    }

                };

                notificationList.appendChild(item);
            });

            notificationBadge.style.display = "flex";
            notificationBadge.textContent = notifications.length;
        }

        function markAsRead(notificationId) {
            const { header: csrfHeader, token: csrfToken } = getCsrf();

            fetch(`/api/notifications/mark-as-read/${notificationId}`, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    [csrfHeader]: csrfToken
                },
                credentials: "include"
            })
                .then(response => {
                    if (!response.ok) throw new Error(`서버 오류: ${response.status}`);
                    return response.text();
                })
                .then(text => {
                    fetchNotifications();
                })
                .catch(error => console.error("알림 상태 업데이트 실패", error));
        }


        document.addEventListener("DOMContentLoaded", function () {
            notificationIcon = document.getElementById("notification-icon");
            const notificationBox = document.getElementById("notification-box");
            const closeNotification = document.getElementById("close-notification");
            notificationList = document.getElementById("notification-list");
            notificationBadge = document.getElementById("notification-badge");
            const clearAllButton = document.getElementById("clear-all");

            fetchNotifications();

            notificationIcon.addEventListener("click", function () {
                notificationBox.style.display = (notificationBox.style.display === "none" || notificationBox.style.display === "") ? "flex" : "none";
            });

            closeNotification.addEventListener("click", function () {
                notificationBox.style.display = "none";
            });

            clearAllButton.addEventListener("click", function () {
                const { header: csrfHeader, token: csrfToken } = getCsrf();

                fetch("/api/notifications/delete-all", {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json",
                        [csrfHeader]: csrfToken
                    },
                    credentials: "include"
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(errorMessage => {
                                throw new Error(`알림 삭제 실패: ${errorMessage}`);
                            });
                        }
                        return response.text();
                    })
                    .then(() => {
                        alert("모든 알림이 삭제되었습니다.");
                        notificationList.innerHTML = "<li class='notification-item'>알림이 없습니다.</li>";
                        notificationBadge.style.display = "none";
                    });
            });

            document.getElementById('accept-btn').addEventListener('click', () => {
                const { header: csrfHeader, token: csrfToken } = getCsrf();

                fetch(`/contest/team/invite/respond?teamId=${currentTeamId}&accept=true`, {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    },
                    credentials: "include"
                }).then(res => {
                    if (res.ok) {
                        alert('초대를 수락했습니다.');
                        closeInviteModal();
                        deleteNotification(currentInviteId);
                    } else {
                        alert('수락 실패');
                    }
                });
            });

            document.getElementById('reject-btn').addEventListener('click', () => {
                const { header: csrfHeader, token: csrfToken } = getCsrf();

                fetch(`/contest/team/invite/respond?teamId=${currentTeamId}&accept=false`, {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    },
                    credentials: "include"
                }).then(res => {
                    if (res.ok) {
                        alert('초대를 거절했습니다.');
                        closeInviteModal();
                        deleteNotification(currentInviteId);
                    } else {
                        alert('거절 실패');
                    }
                });
            });
        });

        function openChatWindow() {
            window.open("/chatting", "ChatWindow", "width=400,height=600,resizable=yes");
        }

        // 팀 초대 관련
        let currentInviteId = null;
        let currentTeamId = null;

        function openInviteModal(inviteId, teamName, teamId, contestId) {
            currentInviteId = inviteId;
            currentTeamId = teamId;

            document.getElementById('invite-text').textContent =
                `'${teamName}' 팀에 초대되었습니다. 수락하시겠습니까?`;

            const viewBtn = document.getElementById('view-contest-btn');
            viewBtn.onclick = function () {
                window.location.href = `/contest/${contestId}`;
            };

            document.getElementById('inviteDecisionModal').style.display = 'flex';
        }

        function closeInviteModal() {
            document.getElementById('inviteDecisionModal').style.display = 'none';
        }



        // ✅ 채용 축하 모달 관련
        function openHireModal(companyName, message, jobPostId) {
            document.getElementById('hire-company').textContent = `지원하신 ${companyName}에 1차 합격 되셨습니다!`;
            document.getElementById('hire-message').textContent = message || '채용을 축하드립니다!';
            document.getElementById('hire-detail-btn').href = jobPostId ? `/jobindex?id=${jobPostId}` : '#';
            document.getElementById('hireModal').style.display = 'flex';
        }


        function closeHireModal() {
            document.getElementById('hireModal').style.display = 'none';
        }

        // ❎ 불합격 모달 열기
        function openRejectModal(companyName, jobPostId) {
            document.getElementById('reject-company').textContent = `${companyName}에서 불합격 안내가 도착했어요.`;
            document.getElementById('reject-detail-btn').href = jobPostId ? `/jobindex?id=${jobPostId}` : '#';
            document.getElementById('rejectModal').style.display = 'flex';
        }

        // ❎ 불합격 모달 닫기
        function closeRejectModal() {
            document.getElementById('rejectModal').style.display = 'none';
        }

        let currentApplicationId = null;
        let currentApplicantId = null;

        function openApplyModal(applicationId, teamName, applicantNick) {
            currentApplicationId = applicationId;
            document.getElementById('apply-text').textContent =
                `'${applicantNick}' 님이 '${teamName}' 팀에 참가 신청을 보냈습니다. 수락하시겠습니까?`;
            document.getElementById('applyTeamModal').style.display = 'flex';
        }

        function closeApplyModal() {
            document.getElementById('applyTeamModal').style.display = 'none';
        }

        document.getElementById('approve-application-btn').addEventListener('click', () => {
            const { header: csrfHeader, token: csrfToken } = getCsrf();
            fetch(`/contest/team/application/respond?applicationId=${currentApplicationId}&accept=true`, {
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken
                },
                credentials: 'include'
            }).then(res => {
                if (res.ok) {
                    alert('신청을 수락했습니다.');
                    closeApplyModal();
                    deleteNotification(currentApplicationId); // 필요 시 알림 삭제
                } else {
                    alert('수락 실패');
                }
            });
        });

        document.getElementById('deny-application-btn').addEventListener('click', () => {
            const { header: csrfHeader, token: csrfToken } = getCsrf();
            fetch(`/contest/team/application/respond?applicationId=${currentApplicationId}&accept=false`, {
                method: 'POST',
                headers: {
                    [csrfHeader]: csrfToken
                },
                credentials: 'include'
            }).then(res => {
                if (res.ok) {
                    alert('신청을 거절했습니다.');
                    closeApplyModal();
                    deleteNotification(currentApplicationId);
                } else {
                    alert('거절 실패');
                }
            });
        });






    </script>
</header>
</div>
</body>
</html>
