<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOB ì‚¬ì´íŠ¸</title>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <!-- CSRF í† í°ì„ ìœ„í•œ meta íƒœê·¸ ì¶”ê°€ (ì¤‘ë³µ ì œê±°) -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

</head>
<body>
<!-- header -->
<div th:fragment="~{header :: header}"></div>

<header>
    <nav class="navigator">
        <div class="nav-left">
            <h3 class="site-name"><a href="/main">BOB</a></h3>
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="#" class="nav-menu">ê³µëª¨ì „</a>
                    <div class="all-dropdown-menu">
                        <div class="dropdown-section">
                            <ul>
                                <li><a href="contest">ì „ì²´ ê³µëª¨ì „</a></li>
                                <li><a th:href="@{/contestact}">ê³µëª¨ì „ í™œë™</a></li>
                                <li><a th:href="@{/likedcontest}">ì°œí•œ ê³µëª¨ì „</a></li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-menu">í”„ë¡œì íŠ¸</a>
                    <div class="all-dropdown-menu">
                        <div class="dropdown-section">
                            <ul>
                                <li><a th:href="@{/project}">í”„ë¡œì íŠ¸</a></li>
                                <li><a href="newproject">í”„ë¡œì íŠ¸ ìƒì„±</a></li>
                                <li><a href="myproject">MY í”„ë¡œì íŠ¸</a></li>
                                <li><a href="#">ì°œí•œ í”„ë¡œì íŠ¸</a></li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-menu">êµ¬ì§</a>
                    <div class="all-dropdown-menu">
                        <div class="dropdown-section">
                            <ul>
                                <li><a href="/job">êµ¬ì¸ ê³µê³ </a></li>
                                <li><a href="/portfoliozip">í¬íŠ¸í´ë¦¬ì˜¤ ëª¨ìŒë°©</a></li>
                                <li><a href="/jobapplication">ì‹ ì²­í•œ êµ¬ì§ ë‚´ì—­</a></li>
                                <li><a href="#">ì°œí•œ ê³µê³ </a></li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-menu">ì´ë ¥ì„œ</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-menu">ê²Œì‹œíŒ</a>
                </li>
            </ul>
        </div>
        <div class="nav-right">
            <div class="search-bar-container">
                <form id="searchForm" action="/search" method="get">
                    <input type="text" name="kw" id="search_kw" class="search-bar" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" th:value="${kw}">
                    <span class="search-icon"><img src="/images/search.png" alt=""></span>
                </form>
            </div>
            <a class="chatting-icon" onclick="openChatWindow()">
                <img src="/images/chatting.png" alt="">
            </a>
            <div class="nav-item1">
                <a class="user-icon">
                    <!-- ë¡œê·¸ì¸ ì•ˆ í•œ ì‚¬ìš©ìë§Œ ì•„ì´ì½˜ í‘œì‹œ -->
                    <img src="/images/user.png" alt="Profile Image" sec:authorize="isAnonymous()" />

                    <!-- ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì—ê²Œë§Œ í”„ë¡œí•„ê³¼ ë‹‰ë„¤ì„ í‘œì‹œ -->
                    <div class="user-profile" sec:authorize="isAuthenticated()">
                        <img class="user-avatar" th:src="${#authentication.principal.userEntity.profileImageUrl}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€">
                        <span class="user-nick" th:text="${#authentication.principal.userEntity.userNick}">ë‹‰ë„¤ì„</span>
                    </div>

                </a>
                <div class="all-dropdown-menu">
                    <div class="dropdown-section">
                        <ul>
                            <!-- ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ -->
                            <li sec:authorize="isAuthenticated()"><a href="/profile">ë‚´ ì •ë³´ / í‰ì </a></li>
                            <li sec:authorize="isAuthenticated()"><a href="#" class="notification-icon" id="notification-icon">ì•Œë¦¼</a><span class="notification-badge" id="notification-badge"></span></li>
                            <li sec:authorize="isAuthenticated()"><a th:href="@{/history}">ê²½ë ¥ ë‚´ì—­</a></li>
                            <li sec:authorize="isAuthenticated()"><a th:href="@{/appstatus}">ì§€ì› í˜„í™©</a></li>
                            <li sec:authorize="isAuthenticated()">
                                <form id="logoutForm" th:action="@{/logout}" method="post">
                                    <button type="submit" class="logout">ë¡œê·¸ì•„ì›ƒ</button>
                                </form>
                            </li>

                            <!-- ë¹„ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ -->
                            <li sec:authorize="isAnonymous()"><a href="/login" id="plz"><img src="/images/login.png">ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- ğŸ“© ì•Œë¦¼ì°½ -->
    <form>
        <div class="notification-box" id="notification-box">
            <div class="notification-header">
                <h3>ì•Œë¦¼</h3>
                <button id="close-notification">&times;</button>
            </div>
            <ul id="notification-list">
                <!-- ì•Œë¦¼ ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
            </ul>
            <div class="notification-footer">
                <button id="clear-all">ëª¨ë‘ ì‚­ì œ</button>
            </div>
        </div>
    </form>

    <!-- âœ… ì—¬ê¸°ì— ì•„ë˜ ëª¨ë‹¬ HTML ì‚½ì… -->
    <div id="inviteDecisionModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeInviteModal()">&times;</span>
            <h3>íŒ€ ì´ˆëŒ€</h3>
            <p id="invite-text">[ë‹‰ë„¤ì„]ë‹˜ì´ '[íŒ€ëª…]' íŒ€ì— ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤.</p>

            <!-- ê³µëª¨ì „ ê³µê³  ë³´ê¸° ë²„íŠ¼ ì¶”ê°€ -->
            <button id="view-contest-btn" class="view-contest-btn">
                ğŸ“„ ê³µëª¨ì „ ê³µê³  ë³´ê¸°
            </button>

            <div class="modal-buttons">
                <button id="accept-btn">ìˆ˜ë½</button>
                <button id="reject-btn">ê±°ì ˆ</button>
            </div>
        </div>
    </div>


    <!-- âœ… ì±„ìš© ì¶•í•˜ ëª¨ë‹¬ -->
    <div id="hireModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeHireModal()">&times;</span>
            <h2>ğŸ‰ í•©ê²© ì¶•í•˜ë“œë¦½ë‹ˆë‹¤!</h2>
            <p id="hire-company" style="font-weight: bold; font-size: 18px;"></p>
            <p id="hire-message">ê¸°ì—…ì˜ ì±„ìš© ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤.</p>

            <div class="modal-buttons">
                <button onclick="closeHireModal()">í™•ì¸</button>
                <a id="hire-detail-btn" href="#" target="_blank" class="view-contest-btn">ìì„¸íˆ ë³´ê¸°</a>
            </div>
        </div>
    </div>

    <!-- â ë¶ˆí•©ê²© ì•ˆë‚´ ëª¨ë‹¬ -->
    <div id="rejectModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeRejectModal()">&times;</span>
            <h2>â ë¶ˆí•©ê²© ì•ˆë‚´</h2>
            <p id="reject-company" style="font-weight: bold; font-size: 18px;"></p>
            <p>ì•ˆíƒ€ê¹ì§€ë§Œ ì´ë²ˆ ì±„ìš©ì—ì„œëŠ” í•¨ê»˜í•˜ì§€ ì•Šê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>

            <div class="modal-buttons">
                <button onclick="closeRejectModal()">í™•ì¸</button>
                <a id="reject-detail-btn" href="#" target="_blank" class="view-contest-btn">ê³µê³  ë³´ê¸°</a>
            </div>
        </div>
    </div>



    <script>
        function getCsrf() {
            const token = document.querySelector('meta[name="_csrf"]')?.getAttribute("content");
            const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute("content");
            return { header, token };
        }

        function deleteNotification(notificationId) {
            const { header: csrfHeader, token: csrfToken } = getCsrf();

            fetch(`/api/notifications/delete/${notificationId}`, {
                method: 'DELETE',
                headers: {
                    [csrfHeader]: csrfToken
                },
                credentials: 'include'
            }).then(() => {
                fetchNotifications(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            }).catch(err => {
                console.error("ì•Œë¦¼ ì‚­ì œ ì‹¤íŒ¨:", err);
            });
        }

        function fetchNotifications() {
            fetch("/api/notifications/count")
                .then(response => response.json())
                .then(data => {
                    const notificationCount = data.notificationsCount;

                    if (notificationCount > 0) {
                        notificationBadge.style.display = "flex";
                        notificationBadge.textContent = notificationCount;
                    } else {
                        notificationBadge.style.display = "none";
                    }
                })
                .catch(error => {
                    console.error("ì•Œë¦¼ ìˆ˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨", error);
                });

            fetch("/api/notifications/list?page=0&size=10")
                .then(response => response.json())
                .then(notifications => {
                    renderNotifications(notifications);
                })
                .catch(error => {
                    console.error("ì•Œë¦¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨", error);
                });
        }

        let notificationBadge;
        let notificationList;
        let notificationIcon;

        function renderNotifications(notifications) {
            notificationList.innerHTML = "";

            if (!Array.isArray(notifications)) {
                console.error("ì•Œë¦¼ ëª©ë¡ ë°ì´í„°ê°€ ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤:", notifications);
                notificationList.innerHTML = "<li class='notification-item'>ì•Œë¦¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>";
                return;
            }

            if (notifications.length === 0) {
                notificationList.innerHTML = "<li class='notification-item'>ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
                notificationBadge.style.display = "none";
                return;
            }

            notifications.forEach(notification => {
                let item = document.createElement("li");
                item.classList.add("notification-item");
                // âœ… ì±„ìš© ì•Œë¦¼ì´ë©´ ê¸°ì—…ëª… ê¸°ë°˜ ë™ì  ë©”ì‹œì§€, ì•„ë‹ˆë©´ ì›ë˜ ë©”ì‹œì§€
                if (notification.type === 'HIRE_NOTICE' && notification.companyName) {
                    item.textContent = `ğŸ“© ${notification.companyName}ì—ì„œ ì±„ìš© ì•Œë¦¼ì´ ë„ì°©í–ˆì–´ìš”!`;
                } else {
                    item.textContent = notification.message;
                }


                item.setAttribute("data-id", notification.id);
                item.setAttribute("data-project-id", notification.projectId || "");
                item.setAttribute("data-user-id", notification.userId || "");

                const currentNotification = { ...notification };

                item.onclick = function (event) {
                    const notificationId = this.getAttribute("data-id");
                    const projectId = this.getAttribute("data-project-id");
                    const userId = this.getAttribute("data-user-id");
                    const contestId = currentNotification.contestId;

                    markAsRead(notificationId);

                    console.log("í´ë¦­ëœ ì•Œë¦¼:", currentNotification);
                    console.log("íƒ€ì…:", currentNotification.type);

                    if (currentNotification.type === 'CONTEST_INVITE') {
                        event.preventDefault();
                        event.stopPropagation();

                        const teamId = currentNotification.teamId;
                        const teamName = currentNotification.teamName;

                        fetch(`/contest/team/api/team/member-id?teamId=${teamId}`)
                            .then(res => res.json())
                            .then(data => {
                                const inviteId = data.inviteId;
                                openInviteModal(inviteId, teamName, teamId, contestId);
                            })
                            .catch(err => {
                                console.error("ì´ˆëŒ€ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:", err);
                                alert("ì´ˆëŒ€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                            });

                        return;
                    }

                    if (currentNotification.type === 'HIRE_NOTICE') {
                        // ğŸ’¡ ë¶ˆí•©ê²© ê³ ì • ë©”ì‹œì§€ë¡œ ë¶„ê¸°
                        if (currentNotification.message === "ì•„ì‰½ê²Œë„ ì´ë²ˆì—ëŠ” í•¨ê»˜í•˜ì§€ ëª»í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.") {
                            openRejectModal(currentNotification.companyName, currentNotification.jobPostId);
                        } else {
                            openHireModal(currentNotification.companyName, currentNotification.message, currentNotification.jobPostId);
                        }
                        return;
                    }




                    if (projectId && userId && projectId !== "undefined" && userId !== "undefined") {
                        window.location.href = `/teamrequest/${projectId}/${userId}`; // âœ… ì˜¬ë°”ë¥¸ URL íŒ¨í„´!
                    }
                    else if (notification.link && notification.link !== "undefined") {
                        window.location.href = currentNotification.link;
                    } else {
                        console.error("ì•Œë¦¼ ë§í¬ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    }

                };

                notificationList.appendChild(item);
            });

            notificationBadge.style.display = "flex";
            notificationBadge.textContent = notifications.length;
        }

        function markAsRead(notificationId) {
            const { header: csrfHeader, token: csrfToken } = getCsrf();

            fetch(`/api/notifications/mark-as-read/${notificationId}`, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    [csrfHeader]: csrfToken
                },
                credentials: "include"
            })
                .then(response => {
                    if (!response.ok) throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                    return response.text();
                })
                .then(text => {
                    fetchNotifications();
                })
                .catch(error => console.error("ì•Œë¦¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨", error));
        }


        document.addEventListener("DOMContentLoaded", function () {
            notificationIcon = document.getElementById("notification-icon");
            const notificationBox = document.getElementById("notification-box");
            const closeNotification = document.getElementById("close-notification");
            notificationList = document.getElementById("notification-list");
            notificationBadge = document.getElementById("notification-badge");
            const clearAllButton = document.getElementById("clear-all");

            fetchNotifications();

            notificationIcon.addEventListener("click", function () {
                notificationBox.style.display = (notificationBox.style.display === "none" || notificationBox.style.display === "") ? "flex" : "none";
            });

            closeNotification.addEventListener("click", function () {
                notificationBox.style.display = "none";
            });

            clearAllButton.addEventListener("click", function () {
                const { header: csrfHeader, token: csrfToken } = getCsrf();

                fetch("/api/notifications/delete-all", {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json",
                        [csrfHeader]: csrfToken
                    },
                    credentials: "include"
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(errorMessage => {
                                throw new Error(`ì•Œë¦¼ ì‚­ì œ ì‹¤íŒ¨: ${errorMessage}`);
                            });
                        }
                        return response.text();
                    })
                    .then(() => {
                        alert("ëª¨ë“  ì•Œë¦¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        notificationList.innerHTML = "<li class='notification-item'>ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
                        notificationBadge.style.display = "none";
                    });
            });

            document.getElementById('accept-btn').addEventListener('click', () => {
                const { header: csrfHeader, token: csrfToken } = getCsrf();

                fetch(`/contest/team/invite/respond?teamId=${currentTeamId}&accept=true`, {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    },
                    credentials: "include"
                }).then(res => {
                    if (res.ok) {
                        alert('ì´ˆëŒ€ë¥¼ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤.');
                        closeInviteModal();
                        deleteNotification(currentInviteId);
                    } else {
                        alert('ìˆ˜ë½ ì‹¤íŒ¨');
                    }
                });
            });

            document.getElementById('reject-btn').addEventListener('click', () => {
                const { header: csrfHeader, token: csrfToken } = getCsrf();

                fetch(`/contest/team/invite/respond?teamId=${currentTeamId}&accept=false`, {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    },
                    credentials: "include"
                }).then(res => {
                    if (res.ok) {
                        alert('ì´ˆëŒ€ë¥¼ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.');
                        closeInviteModal();
                        deleteNotification(currentInviteId);
                    } else {
                        alert('ê±°ì ˆ ì‹¤íŒ¨');
                    }
                });
            });
        });

        function openChatWindow() {
            window.open("/chatting", "ChatWindow", "width=400,height=600,resizable=yes");
        }

        // íŒ€ ì´ˆëŒ€ ê´€ë ¨
        let currentInviteId = null;
        let currentTeamId = null;

        function openInviteModal(inviteId, teamName, teamId, contestId) {
            currentInviteId = inviteId;
            currentTeamId = teamId;

            document.getElementById('invite-text').textContent =
                `'${teamName}' íŒ€ì— ì´ˆëŒ€ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

            const viewBtn = document.getElementById('view-contest-btn');
            viewBtn.onclick = function () {
                window.location.href = `/contest/${contestId}`;
            };

            document.getElementById('inviteDecisionModal').style.display = 'flex';
        }

        function closeInviteModal() {
            document.getElementById('inviteDecisionModal').style.display = 'none';
        }



        // âœ… ì±„ìš© ì¶•í•˜ ëª¨ë‹¬ ê´€ë ¨
        function openHireModal(companyName, message, jobPostId) {
            document.getElementById('hire-company').textContent = `ì§€ì›í•˜ì‹  ${companyName}ì— 1ì°¨ í•©ê²© ë˜ì…¨ìŠµë‹ˆë‹¤!`;
            document.getElementById('hire-message').textContent = message || 'ì±„ìš©ì„ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤!';
            document.getElementById('hire-detail-btn').href = jobPostId ? `/jobindex?id=${jobPostId}` : '#';
            document.getElementById('hireModal').style.display = 'flex';
        }


        function closeHireModal() {
            document.getElementById('hireModal').style.display = 'none';
        }

        // â ë¶ˆí•©ê²© ëª¨ë‹¬ ì—´ê¸°
        function openRejectModal(companyName, jobPostId) {
            document.getElementById('reject-company').textContent = `${companyName}ì—ì„œ ë¶ˆí•©ê²© ì•ˆë‚´ê°€ ë„ì°©í–ˆì–´ìš”.`;
            document.getElementById('reject-detail-btn').href = jobPostId ? `/jobindex?id=${jobPostId}` : '#';
            document.getElementById('rejectModal').style.display = 'flex';
        }

        // â ë¶ˆí•©ê²© ëª¨ë‹¬ ë‹«ê¸°
        function closeRejectModal() {
            document.getElementById('rejectModal').style.display = 'none';
        }


    </script>
</header>
</div>
</body>
</html>
