<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOB 사이트</title>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <!-- CSRF 토큰을 위한 meta 태그 추가 (중복 제거) -->
    <meta name="_csrf" content="${_csrf.token}" />
</head>
<body>
<!-- header -->
<div th:fragment="~{header :: header}"></div>

<header>
    <nav class="navigator">
        <div class="nav-left">
            <h3 class="site-name"><a href="/main">BOB</a></h3>
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="#" class="nav-menu">공모전</a>
                    <div class="all-dropdown-menu">
                        <div class="dropdown-section">
                            <ul>
                                <li><a href="contest">전체 공모전</a></li>
                                <li><a th:href="@{/contestact}">공모전 활동</a></li>
                                <li><a th:href="@{/likedcontest}">찜한 공모전</a></li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-menu">프로젝트</a>
                    <div class="all-dropdown-menu">
                        <div class="dropdown-section">
                            <ul>
                                <li><a th:href="@{/project}">프로젝트</a></li>
                                <li><a href="newproject">프로젝트 생성</a></li>
                                <li><a href="myproject">MY 프로젝트</a></li>
                                <li><a href="#">찜한 프로젝트</a></li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-menu">구직</a>
                    <div class="all-dropdown-menu">
                        <div class="dropdown-section">
                            <ul>
                                <li><a href="#">구인 공고</a></li>
                                <li><a href="#">포트폴리오 모음방</a></li>
                                <li><a href="#">신청한 구직 내역</a></li>
                                <li><a href="#">찜한 공고</a></li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-menu">이력서</a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-menu">게시판</a>
                </li>
            </ul>
        </div>
        <div class="nav-right">
            <div class="search-bar-container">
                <form id="searchForm">
                    <input type="text" name="kw" id="search_kw" class="search-bar" placeholder="검색어 입력" th:value="${kw}">
                    <span class="search-icon"><img src="/images/search.png" alt=""></span>
                </form>
            </div>
            <a class="chatting-icon">
                <img src="/images/chatting.png" alt="">
            </a>
            <div class="nav-item1">
                <a class="user-icon">
                    <img src="/images/user.png" alt="Profile Image">
                </a>
                <div class="all-dropdown-menu">
                    <div class="dropdown-section">
                        <ul>
                            <!-- 로그인 상태일 때 -->
                            <li th:if="${user != null}"><a href="/profile">내 정보 / 평점</a></li>
                            <li th:if="${user != null}"><a href="#" class="notification-icon" id="notification-icon">알림</a><span class="notification-badge" id="notification-badge"></span></li>
                            <li th:if="${user != null}"><a th:href="@{/history}">경력 내역</a></li>
                            <li th:if="${user != null}"><a th:href="@{/appstatus}">지원 현황</a></li>
                            <li th:if="${user != null}">
                                <form id="logoutForm" th:action="@{/logout}" method="post">
                                    <button type="submit" class="logout">로그아웃</button>
                                </form>
                            </li>

                            <!-- 비로그인 상태일 때 -->
                            <li th:unless="${user != null}"><a href="/login" id="plz"><img src="/images/login.png">로그인 해주세요</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 📩 알림창 -->
    <form>
        <div class="notification-box" id="notification-box">
            <div class="notification-header">
                <h3>알림</h3>
                <button id="close-notification">&times;</button>
            </div>
            <ul id="notification-list">
                <!-- 알림 데이터가 여기에 동적으로 추가됨 -->
            </ul>
            <div class="notification-footer">
                <button id="clear-all">모두 삭제</button>
            </div>
        </div>
    </form>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const notificationIcon = document.getElementById("notification-icon");
            const notificationBox = document.getElementById("notification-box");
            const closeNotification = document.getElementById("close-notification");
            const notificationList = document.getElementById("notification-list");
            const notificationBadge = document.getElementById("notification-badge");
            const clearAllButton = document.getElementById("clear-all");

            // 알림 목록 불러오기
            fetchNotifications();

            // 알림 목록 렌더링
            function renderNotifications(notifications) {
                notificationList.innerHTML = ""; // 기존 목록 초기화

                if (!Array.isArray(notifications)) {
                    console.error("알림 목록 데이터가 배열이 아닙니다:", notifications);
                    notificationList.innerHTML = "<li class='notification-item'>알림 목록을 불러올 수 없습니다.</li>";
                    return;
                }

                if (notifications.length === 0) {
                    notificationList.innerHTML = "<li class='notification-item'>알림이 없습니다.</li>";
                    notificationBadge.style.display = "none"; // 알림 배지 숨기기
                    return;
                }

                notifications.forEach(notification => {
                    let item = document.createElement("li");
                    item.classList.add("notification-item");
                    item.textContent = notification.message;

                    // 알림 ID 및 프로젝트 ID를 data 속성에 저장
                    item.setAttribute("data-id", notification.id);
                    item.setAttribute("data-project-id", notification.projectId || "");
                    item.setAttribute("data-user-id", notification.userId || "");

                    // 알림 클릭 시 읽음 상태로 업데이트하고 페이지 이동
                    item.onclick = function () {
                        const notificationId = this.getAttribute("data-id");
                        const projectId = this.getAttribute("data-project-id");
                        const userId = this.getAttribute("data-user-id");

                        if (!notificationId || notificationId === "undefined") {
                            console.error("알림 ID가 유효하지 않습니다!");
                            return;
                        }

                        markAsRead(notificationId); // 알림 읽음 처리

                        // 프로젝트 ID가 있으면 팀 신청 수락/거절 페이지로 이동
                        if (projectId && projectId !== "undefined") {
                            window.location.href = `/teamrequest?projectId=${projectId}&userId=${userId}`;
                        } else if (notification.link && notification.link !== "undefined") {
                            window.location.href = notification.link;
                        } else {
                            console.error("알림 링크가 설정되지 않았습니다.");
                        }
                    };

                    notificationList.appendChild(item);
                });

                notificationBadge.style.display = "flex"; // 알림 배지 보이기
                notificationBadge.textContent = notifications.length; // 알림 개수 표시
            }

            // 알림 수 및 목록을 가져오는 함수
            function fetchNotifications() {
                // 알림 수 가져오기
                fetch("/api/notifications/count")
                    .then(response => response.json())
                    .then(data => {
                        const notificationCount = data.notificationCount;

                        if (notificationCount > 0) {
                            notificationBadge.style.display = "flex"; // 배지 보이기
                            notificationBadge.textContent = notificationCount; // 알림 수 표시
                        } else {
                            notificationBadge.style.display = "none"; // 알림 수가 없으면 배지 숨기기
                        }
                    })
                    .catch(error => {
                        console.error("알림 수 가져오기 실패", error);
                    });

                // 알림 목록 가져오기
                fetch("/api/notifications/list?page=0&size=10") // 페이지네이션을 위한 쿼리 파라미터 추가
                    .then(response => response.json())
                    .then(notifications => {
                        renderNotifications(notifications); // 알림 목록 렌더링
                    })
                    .catch(error => {
                        console.error("알림 목록 가져오기 실패", error);
                    });
            }

            // 알림을 읽음 상태로 처리하는 함수
            function markAsRead(notificationId) {
                fetch(`/api/notifications/mark-as-read/${notificationId}`, {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRF-TOKEN": getCsrfToken() // CSRF 토큰 추가
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`서버 오류: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        fetchNotifications(); // 알림 리스트 다시 렌더링
                    })
                    .catch(error => console.error("알림 상태 업데이트 실패", error));
            }

            // CSRF 토큰을 가져오는 함수
            function getCsrfToken() {
                const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute("content");
                return csrfToken ? csrfToken : ''; // CSRF 토큰이 없을 경우 빈 문자열 반환
            }

            // 알림 아이콘 클릭 시 알림창 표시/숨김
            notificationIcon.addEventListener("click", function () {
                notificationBox.style.display = (notificationBox.style.display === "none" || notificationBox.style.display === "") ? "flex" : "none";
            });

            // 알림창 닫기 버튼
            closeNotification.addEventListener("click", function () {
                notificationBox.style.display = "none";
            });

            // "모두 삭제" 버튼
            clearAllButton.addEventListener("click", function () {
                fetch("/api/notifications/delete-all", {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRF-TOKEN": getCsrfToken() // CSRF 토큰 추가
                    },
                    credentials: "include"  // 쿠키와 세션을 포함하여 요청
                })
                    .then(response => {
                        if (!response.ok) {
                            // 응답이 성공적이지 않으면 오류 메시지를 처리
                            return response.text().then(errorMessage => {
                                throw new Error(`알림 삭제 실패: ${errorMessage}`);
                            });
                        }
                        return response.text(); // 성공적으로 삭제되면 서버 응답을 반환
                    })
                    .then(data => {
                        alert("모든 알림이 삭제되었습니다.");
                        notificationList.innerHTML = "<li class='notification-item'>알림이 없습니다.</li>"; // UI 업데이트
                        notificationBadge.style.display = "none"; // 배지 숨기기
                    })
                
            });

        });
    </script>
</header>
</div>
x
</body>
</html>
