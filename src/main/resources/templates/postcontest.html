<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <meta name="logged-in-user-id" th:content="${#authentication.principal.userEntity.userId}" />
    <title>ê³µëª¨ì „ ìƒì„¸ í˜ì´ì§€</title>
    <link rel="stylesheet" href="/css/postcontest.css" />
    <link rel="stylesheet" th:href="@{/css/header.css}" />
</head>
<body>

<!-- header -->
<div sec:authorize="!hasAuthority('ADMIN')" th:replace="~{header :: header}"></div>

<!-- ê³µëª¨ì „ ìƒì„¸ ì •ë³´ -->
<section class="contest-detail">
    <div class="contest-header">
        <h2 th:text="${contest.title}">2025 í†µê³„ ì²­ì†Œë…„ IT í•™ìˆ ëŒ€íšŒ</h2>
        <div class="status-badge" id="status-badge" th:text="${contest.status} ?: 'ëª¨ì§‘ì¤‘'"></div>
        <button class="bookmark-btn" sec:authorize="!hasRole('ADMIN')">â­</button>
    </div>

    <div class="contest-content">
        <img th:src="@{${contest.imageUrl}}" alt="ê³µëª¨ì „ ë°°ë„ˆ" class="contest-banner" />
        <table class="contest-table">
            <tr><th>ì£¼ìµœ/ì£¼ê´€</th><td th:text="${contest.organizer}">ì£¼ìµœ</td></tr>
            <tr><th>ëŒ€í‘œ ë¶„ì•¼</th><td th:text="${contest.category}">ë¶„ì•¼</td></tr>
            <tr><th>ì°¸ê°€ ëŒ€ìƒ</th><td th:text="${contest.target}">ëŒ€ìƒ</td></tr>
            <tr><th>ëŒ€íšŒ ì§€ì—­</th><td th:text="${contest.region}">ì§€ì—­</td></tr>
            <tr><th>ì§„í–‰ ê¸°ê°„</th>
                <td th:text="${contest.startDate} + ' ~ ' + ${contest.endDate}">2025-01-01 ~ 2025-03-01</td>
            </tr>
            <tr><th>ì‹¬ì‚¬ ê¸°ê´€</th><td th:text="${contest.judge}">ì‹¬ì‚¬</td></tr>
            <tr><th>ì‹œìƒ ë‚´ì—­</th><td th:text="${contest.awardDetails}">ìƒì„¸</td></tr>
            <tr><th>ì›¹ì‚¬ì´íŠ¸</th>
                <td><a th:href="@{${contest.applicationMethod}}" target="_blank">ê³µì‹ í™ˆí˜ì´ì§€</a></td>
            </tr>
        </table>
    </div>

    <!-- ìƒì„¸ ì„¤ëª… -->
    <section class="contest-details">
        <div th:text="${contest.description}" id="contest-description">ìƒì„¸ì„¤ëª…</div>
    </section>

    <!-- ë²„íŠ¼ -->
    <div class="button-box" sec:authorize="!hasRole('ADMIN')">
        <button class="apply-btn" id="openModalBtn">ê³µëª¨ì „ ì°¸ê°€í•˜ê¸°</button>
        <button class="recruit-btn">íŒ€ì› ëª¨ì§‘ê¸€ ì‘ì„±í•˜ê¸°</button>
    </div>

    <!-- íŒ€ì› ëª¨ì§‘ê¸€ ë¦¬ìŠ¤íŠ¸ -->
    <section class="recruit-list">
        <h3>ğŸ“‹ íŒ€ì› ëª¨ì§‘ ê¸€</h3>
        <table class="recruit-table">
            <thead>
            <tr>
                <th>ì œëª©</th>
                <th>ì‘ì„±ì</th>
                <th>ëª¨ì§‘ ì¸ì›</th>
                <th>ë“±ë¡ì¼</th>
                <th>ìƒì„¸ë³´ê¸°</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="recruit : ${recruitList}">
                <td th:text="${recruit.title}">ëª¨ì§‘ê¸€ ì œëª©</td>
                <td th:text="${recruit.writer}">ì‘ì„±ì</td>
                <td th:text="${recruit.recruitCount}">3ëª…</td>
                <td th:text="${#temporals.format(recruit.createdAt, 'yyyy.MM.dd')}">2025.04.01</td>
                <td><a th:href="@{'/recruit/' + ${recruit.id}}">ë³´ê¸°</a></td>
            </tr>
            <tr th:if="${#lists.isEmpty(recruitList)}">
                <td colspan="5" style="text-align:center; color:gray;">ëª¨ì§‘ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
            </tbody>
        </table>
    </section>
</section>

<!-- ëª¨ë‹¬ -->
<div id="contestModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>ê³µëª¨ì „ ì°¸ê°€í•˜ê¸°</h2>

        <div class="invite-section">
            <label for="invite-input">íŒ€ì› ë‹‰ë„¤ì„ ë˜ëŠ” ID</label>
            <input type="text" id="invite-input" placeholder="ë‹‰ë„¤ì„ ë˜ëŠ” ID ì…ë ¥" autocomplete="off" />
            <ul id="autocomplete-list" class="autocomplete-list"></ul>
            <div id="selected-members" class="selected-members"></div>
        </div>

        <button class="btn invite-btn">ğŸ‘¥ ì¹œêµ¬ì™€ ì°¸ê°€</button>
        <button class="btn solo-btn">ğŸ§ í˜¼ì ì°¸ê°€</button>
    </div>
</div>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", () => {
        const openModalBtn = document.getElementById('openModalBtn');
        const contestModal = document.getElementById('contestModal');
        const closeModalBtn = document.querySelector('.close-btn');
        const input = document.getElementById('invite-input');
        const list = document.getElementById('autocomplete-list');
        const selected = document.getElementById('selected-members');
        const loggedInUserId = document.querySelector('meta[name="logged-in-user-id"]')?.content || 0;

        const csrfToken = document.querySelector('meta[name="_csrf"]').content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

        let selectedList = [];

        // ëª¨ë‹¬ ì—´ê¸°
        openModalBtn?.addEventListener('click', () => {
            contestModal.style.display = 'block';
            list.innerHTML = '';   // ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
            input.value = '';      // ì…ë ¥ì°½ ì´ˆê¸°í™”
        });

        // ëª¨ë‹¬ ë‹«ê¸°
        closeModalBtn?.addEventListener('click', () => contestModal.style.display = 'none');
        window.addEventListener('click', (e) => {
            if (e.target === contestModal) contestModal.style.display = 'none';
        });

        // â— input ë¦¬ìŠ¤ë„ˆ: "í•œ ë²ˆë§Œ ë“±ë¡" (DOMContentLoaded ì•ˆì—ì„œ)
        input.addEventListener('input', async () => {
            const query = input.value.trim();
            list.innerHTML = '';
            if (!query) return;

            try {
                const response = await fetch(`/api/users/search?keyword=${encodeURIComponent(query)}`);
                const users = await response.json();

                const filtered = users.filter(user =>
                    user.role !== 'ADMIN' &&
                    Number(user.id) !== Number(loggedInUserId) &&
                    !selectedList.some(selected => Number(selected.userId) === Number(user.id))
                );

                filtered.forEach(user => {
                    if (list.querySelector(`li[data-user-id="${user.id}"]`)) return;

                    const li = document.createElement('li');
                    li.textContent = `${user.nickname} (${user.userIdLogin})`;
                    li.dataset.userId = user.id;
                    li.dataset.nickname = user.nickname;
                    li.dataset.avatar = user.avatar || '/images/user.png';
                    list.appendChild(li);
                });

            } catch (err) {
                console.error('ê²€ìƒ‰ ì‹¤íŒ¨:', err);
            }
        });

        if (!list.dataset.listenerAdded) {
            list.addEventListener('click', (e) => {
                const target = e.target.closest('li');
                if (!target) return;

                const userId = Number(target.dataset.userId);
                const nickname = target.dataset.nickname;
                const avatar = target.dataset.avatar;

                if (selectedList.some(user => Number(user.userId) === userId)) {
                    console.warn('ì´ë¯¸ ì„ íƒëœ ì‚¬ìš©ìì…ë‹ˆë‹¤:', nickname);
                    return;
                }

                selectedList.push({ userId, nickname, avatar });
                addSelectedMember(userId, nickname, avatar);

                input.value = '';
                list.innerHTML = '';
            });

            list.dataset.listenerAdded = "true"; // ì¤‘ë³µ ë°©ì§€
        }


        function addSelectedMember(userId, nickname, avatar) {
            const tag = document.createElement('div');
            tag.className = 'member-tag';
            tag.dataset.id = userId;
            tag.innerHTML = `
            <img src="${avatar}" alt="avatar" />
            ${nickname}
            <button type="button" class="remove-btn">&times;</button>
        `;
            tag.querySelector('.remove-btn').addEventListener('click', () => {
                removeMember(userId, tag);
            });
            selected.appendChild(tag);
        }

        function removeMember(userId, tagElement) {
            selectedList = selectedList.filter(u => String(u.userId) !== String(userId));
            tagElement.remove();
        }

        window.selectedMembers = () => selectedList.map(u => u.userId);

        // ì¹œêµ¬ë‘ ì°¸ì—¬
        document.querySelector('.invite-btn')?.addEventListener('click', async () => {
            const userIds = selectedMembers(); // ì„ íƒëœ ì¹œêµ¬ë“¤
            const contestId = /*[[${contest.id}]]*/ 0;

            try {
                const response = await fetch('/contest/team/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify({ contestId, memberIds: userIds })
                });

                if (response.ok) {
                    alert('ì°¸ê°€ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    location.reload();
                } else {
                    alert('ìš”ì²­ ì‹¤íŒ¨!');
                }
            } catch (err) {
                console.error('ì¹œêµ¬ì™€ ì°¸ê°€ ì‹¤íŒ¨:', err);
            }
        });

        // í˜¼ì ì°¸ì—¬
        document.querySelector('.solo-btn')?.addEventListener('click', async () => {
            const contestId = /*[[${contest.id}]]*/ 0;

            try {
                const response = await fetch('/contest/team/solo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify({ contestId })
                });

                if (response.ok) {
                    alert('ë‹¨ë… ì°¸ê°€ ì™„ë£Œ!');
                    location.reload();
                } else {
                    alert('ìš”ì²­ ì‹¤íŒ¨!');
                }
            } catch (err) {
                console.error('í˜¼ì ì°¸ê°€ ì‹¤íŒ¨:', err);
            }
        });
    });

</script>

</body>
</html>
