<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>공모전 상세 페이지</title>
    <link rel="stylesheet" href="/css/postcontest.css" />
    <link rel="stylesheet" th:href="@{/css/header.css}" />
</head>
<body>

<!-- header -->
<div sec:authorize="!hasAuthority('ADMIN')" th:replace="~{header :: header}"></div>

<!-- 공모전 상세 정보 -->
<section class="contest-detail">
    <div class="contest-header">
        <h2 th:text="${contest.title}">2025 통계 청소년 IT 학술대회</h2> <!-- 공모전명-->
        <div class="status-badge" id="status-badge">모집중</div>
        <button class="bookmark-btn" id="bookmark-btn" sec:authorize="!hasRole('ADMIN')">⭐</button>
    </div>

    <div class="contest-content">
        <!-- 공모전 대표 이미지 -->
        <img th:src="@{${contest.imageUrl}}" alt="공모전 배너" class="contest-banner" />

        <!-- 공모전 정보 테이블 -->
        <table class="contest-table">
            <tr><th>주최/주관</th><td th:text="${contest.organizer}">한국정보기술융합회</td></tr>
            <tr><th>대표 분야</th><td th:text="${contest.category}">논문</td></tr>
            <tr><th>참가 대상</th><td th:text="${contest.target}">청소년, 어린이</td></tr>
            <tr><th>대회 지역</th><td th:text="${contest.region}">대전지역</td></tr>
            <tr>
                <th>진행 기간</th>
                <td th:text="${contest.startDate} + ' ~ ' + ${contest.endDate}">2024.11.14 ~ 2025.03.12</td>
            </tr>
            <tr><th>심사 기관</th><td th:text="${contest.judge}">서울 소재 대학교</td></tr>
            <tr><th>시상 내역</th><td th:text="${contest.awardDetails}">장학금(대학진학 혜택)</td></tr>
            <tr>
                <th>웹사이트</th>
                <td><a th:href="@{${contest.applicationMethod}}" target="_blank">공식 홈페이지</a>
                </td>
            </tr>
        </table>
    </div>

    <!-- 공모전 상세 내용 -->
    <section class="contest-details">
        <div th:text="${contest.description}" id="contest-description">상세페이지</div>
    </section>

    <!-- 버튼 영역 -->
    <div class="button-box" sec:authorize="!hasRole('ADMIN')">
        <button class="apply-btn" id="openModalBtn">공모전 참가하기</button>
        <button class="recruit-btn">팀원 모집글 작성하기</button>
    </div>


    <!-- 팀원 모집글 리스트 -->
    <section class="recruit-list">
        <h3>📋 팀원 모집 글</h3>
        <table class="recruit-table">
            <thead>
            <tr>
                <th>제목</th>
                <th>작성자</th>
                <th>모집 인원</th>
                <th>등록일</th>
                <th>상세보기</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="recruit : ${recruitList}">
                <td th:text="${recruit.title}">AI 공모전 함께하실 분!</td>
                <td th:text="${recruit.writer}">홍길동</td>
                <td th:text="${recruit.recruitCount}">3명</td>
                <td th:text="${#temporals.format(recruit.createdAt, 'yyyy.MM.dd')}">2025.03.20</td>
                <td><a th:href="@{'/recruit/' + ${recruit.id}}" class="detail-link">보기</a></td>
            </tr>
            <tr th:if="${#lists.isEmpty(recruitList)}">
                <td colspan="5" style="text-align:center; color:gray;">모집 글이 없습니다.</td>
            </tr>
            </tbody>
        </table>
    </section>
</section>

<div id="contestModal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>공모전 참가하기</h2>

        <div class="invite-section">
            <label for="invite-input" id="invite-title">팀원 닉네임 또는 ID</label>
            <input type="text" id="invite-input" placeholder="Enter nickname or ID" />

            <!-- 자동완성 리스트 -->
            <ul id="autocomplete-list" class="autocomplete-list"></ul>

            <!-- 선택된 팀원들 -->
            <div id="selected-members" class="selected-members"></div>
        </div>

        <button class="btn invite-btn">👥 친구와 함께 참가하기</button>
        <button class="btn solo-btn">🧍 혼자 참가하기</button>

        <p class="terms">혼자 참가하기 눌러서 팀 모집을 통해 다른 사용자와 함께 참가 가능합니다.</p>
    </div>
</div>

<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>공모전 상세 페이지</title>
    <link rel="stylesheet" href="/css/postcontest.css" />
    <link rel="stylesheet" th:href="@{/css/header.css}" />
</head>
<body>

<!-- header -->
<div sec:authorize="!hasAuthority('ADMIN')" th:replace="~{header :: header}"></div>

<!-- 공모전 상세 정보 -->
<section class="contest-detail">
    <div class="contest-header">
        <h2 th:text="${contest.title}">2025 통계 청소년 IT 학술대회</h2> <!-- 공모전명-->
        <div class="status-badge" id="status-badge">모집중</div>
        <button class="bookmark-btn" id="bookmark-btn" sec:authorize="!hasRole('ADMIN')">⭐</button>
    </div>

    <div class="contest-content">
        <!-- 공모전 대표 이미지 -->
        <img th:src="@{${contest.imageUrl}}" alt="공모전 배너" class="contest-banner" />

        <!-- 공모전 정보 테이블 -->
        <table class="contest-table">
            <tr><th>주최/주관</th><td th:text="${contest.organizer}">한국정보기술융합회</td></tr>
            <tr><th>대표 분야</th><td th:text="${contest.category}">논문</td></tr>
            <tr><th>참가 대상</th><td th:text="${contest.target}">청소년, 어린이</td></tr>
            <tr><th>대회 지역</th><td th:text="${contest.region}">대전지역</td></tr>
            <tr>
                <th>진행 기간</th>
                <td th:text="${contest.startDate} + ' ~ ' + ${contest.endDate}">2024.11.14 ~ 2025.03.12</td>
            </tr>
            <tr><th>심사 기관</th><td th:text="${contest.judge}">서울 소재 대학교</td></tr>
            <tr><th>시상 내역</th><td th:text="${contest.awardDetails}">장학금(대학진학 혜택)</td></tr>
            <tr>
                <th>웹사이트</th>
                <td><a th:href="@{${contest.applicationMethod}}" target="_blank">공식 홈페이지</a>
                </td>
            </tr>
        </table>
    </div>

    <!-- 공모전 상세 내용 -->
    <section class="contest-details">
        <div th:text="${contest.description}" id="contest-description">상세페이지</div>
    </section>

    <!-- 버튼 영역 -->
    <div class="button-box" sec:authorize="!hasRole('ADMIN')">
        <button class="apply-btn" id="openModalBtn">공모전 참가하기</button>
        <button class="recruit-btn">팀원 모집글 작성하기</button>
    </div>


    <!-- 팀원 모집글 리스트 -->
    <section class="recruit-list">
        <h3>📋 팀원 모집 글</h3>
        <table class="recruit-table">
            <thead>
            <tr>
                <th>제목</th>
                <th>작성자</th>
                <th>모집 인원</th>
                <th>등록일</th>
                <th>상세보기</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="recruit : ${recruitList}">
                <td th:text="${recruit.title}">AI 공모전 함께하실 분!</td>
                <td th:text="${recruit.writer}">홍길동</td>
                <td th:text="${recruit.recruitCount}">3명</td>
                <td th:text="${#temporals.format(recruit.createdAt, 'yyyy.MM.dd')}">2025.03.20</td>
                <td><a th:href="@{'/recruit/' + ${recruit.id}}" class="detail-link">보기</a></td>
            </tr>
            <tr th:if="${#lists.isEmpty(recruitList)}">
                <td colspan="5" style="text-align:center; color:gray;">모집 글이 없습니다.</td>
            </tr>
            </tbody>
        </table>
    </section>
</section>

<div id="contestModal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>공모전 참가하기</h2>

        <div class="invite-section">
            <label for="invite-input" id="invite-title">팀원 닉네임 또는 ID</label>
            <input type="text" id="invite-input" placeholder="Enter nickname or ID" />

            <!-- 자동완성 리스트 -->
            <ul id="autocomplete-list" class="autocomplete-list"></ul>

            <!-- 선택된 팀원들 -->
            <div id="selected-members" class="selected-members"></div>
        </div>

        <button class="btn invite-btn">👥 친구와 함께 참가하기</button>
        <button class="btn solo-btn">🧍 혼자 참가하기</button>

        <p class="terms">혼자 참가하기 눌러서 팀 모집을 통해 다른 사용자와 함께 참가 가능합니다.</p>
    </div>
</div>

<<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", () => {
        const input = document.getElementById('invite-input');
        const list = document.getElementById('autocomplete-list');
        const selected = document.getElementById('selected-members');
        const inviteBtn = document.querySelector(".invite-btn");
        const soloBtn = document.querySelector(".solo-btn");
        const contestId = /*[[${contest.id}]]*/ 0; // 공모전 ID
        let selectedList = [];

        // 검색창 입력
        input.addEventListener('input', async () => {
            const query = input.value.trim();
            list.innerHTML = '';

            if (!query) return;

            try {
                const response = await fetch(`/api/users/search?keyword=${encodeURIComponent(query)}`);
                const users = await response.json();

                users.forEach(user => {
                    // 이미 선택한 사람은 걸러주기
                    if (selectedList.some(sel => sel.userId === user.userId)) return;

                    const li = document.createElement('li');
                    li.textContent = `${user.nickname} (${user.userIdLogin})`;
                    li.dataset.userId = user.userId;
                    li.dataset.nickname = user.nickname;
                    li.dataset.avatar = user.avatar || '/images/user.png';

                    li.addEventListener('click', () => {
                        selectedList.push({
                            userId: user.userId,
                            nickname: user.nickname,
                            avatar: user.avatar || '/images/user.png'
                        });
                        renderSelectedMembers();
                        input.value = '';
                        list.innerHTML = '';
                    });

                    list.appendChild(li);
                });
            } catch (error) {
                console.error('❌ 검색 실패:', error);
            }
        });

        // 선택한 멤버 표시
        function renderSelectedMembers() {
            selected.innerHTML = '';
            selectedList.forEach(user => {
                const tag = document.createElement('div');
                tag.className = 'member-tag';
                tag.innerHTML = `
                <img src="${user.avatar}" alt="avatar" />
                ${user.nickname}
                <button type="button" class="remove-btn" data-user-id="${user.userId}">&times;</button>
            `;
                selected.appendChild(tag);
            });

            // 삭제 버튼 이벤트
            document.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const userId = parseInt(e.target.dataset.userId);
                    selectedList = selectedList.filter(u => u.userId !== userId);
                    renderSelectedMembers();
                });
            });
        }

        // ✅ 선택된 유저 ID 리스트
        window.selectedMembers = () => selectedList.map(user => user.userId);

        // 친구와 함께 참가하기 버튼
        inviteBtn.addEventListener('click', () => {
            const members = selectedMembers();
            if (members.length === 0) {
                alert('팀원을 선택하세요!');
                return;
            }
            sendTeamRequest(members);
        });

        // 혼자 참가하기 버튼
        soloBtn.addEventListener('click', () => {
            sendTeamRequest([]);
        });

        function sendTeamRequest(memberIds) {
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

            fetch("/contest/team/create", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    [csrfHeader]: csrfToken
                },
                credentials: "include",
                body: JSON.stringify({
                    contestId: contestId,
                    memberIds: memberIds
                })
            }).then(res => {
                if (res.ok) {
                    alert("성공했습니다!");
                    location.reload();
                } else {
                    alert("실패했습니다.");
                }
            }).catch(error => {
                console.error('❌ 요청 실패:', error);
                alert('에러가 발생했습니다.');
            });
        }
    });
</script>


</body>
</html>
