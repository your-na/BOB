<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>ê³µëª¨ì „ ìƒì„¸ í˜ì´ì§€</title>
    <link rel="stylesheet" href="/css/postcontest.css" />
    <link rel="stylesheet" th:href="@{/css/header.css}" />
</head>
<body>

<!-- header -->
<div sec:authorize="!hasAuthority('ADMIN')" th:replace="~{header :: header}"></div>

<!-- ê³µëª¨ì „ ìƒì„¸ ì •ë³´ -->
<section class="contest-detail">
    <div class="contest-header">
        <h2 th:text="${contest.title}">2025 í†µê³„ ì²­ì†Œë…„ IT í•™ìˆ ëŒ€íšŒ</h2> <!-- ê³µëª¨ì „ëª…-->
        <div class="status-badge" id="status-badge">ëª¨ì§‘ì¤‘</div>
        <button class="bookmark-btn" id="bookmark-btn" sec:authorize="!hasRole('ADMIN')">â­</button>
    </div>

    <div class="contest-content">
        <!-- ê³µëª¨ì „ ëŒ€í‘œ ì´ë¯¸ì§€ -->
        <img th:src="@{${contest.imageUrl}}" alt="ê³µëª¨ì „ ë°°ë„ˆ" class="contest-banner" />

        <!-- ê³µëª¨ì „ ì •ë³´ í…Œì´ë¸” -->
        <table class="contest-table">
            <tr><th>ì£¼ìµœ/ì£¼ê´€</th><td th:text="${contest.organizer}">í•œêµ­ì •ë³´ê¸°ìˆ ìœµí•©íšŒ</td></tr>
            <tr><th>ëŒ€í‘œ ë¶„ì•¼</th><td th:text="${contest.category}">ë…¼ë¬¸</td></tr>
            <tr><th>ì°¸ê°€ ëŒ€ìƒ</th><td th:text="${contest.target}">ì²­ì†Œë…„, ì–´ë¦°ì´</td></tr>
            <tr><th>ëŒ€íšŒ ì§€ì—­</th><td th:text="${contest.region}">ëŒ€ì „ì§€ì—­</td></tr>
            <tr>
                <th>ì§„í–‰ ê¸°ê°„</th>
                <td th:text="${contest.startDate} + ' ~ ' + ${contest.endDate}">2024.11.14 ~ 2025.03.12</td>
            </tr>
            <tr><th>ì‹¬ì‚¬ ê¸°ê´€</th><td th:text="${contest.judge}">ì„œìš¸ ì†Œì¬ ëŒ€í•™êµ</td></tr>
            <tr><th>ì‹œìƒ ë‚´ì—­</th><td th:text="${contest.awardDetails}">ì¥í•™ê¸ˆ(ëŒ€í•™ì§„í•™ í˜œíƒ)</td></tr>
            <tr>
                <th>ì›¹ì‚¬ì´íŠ¸</th>
                <td><a th:href="@{${contest.applicationMethod}}" target="_blank">ê³µì‹ í™ˆí˜ì´ì§€</a>
                </td>
            </tr>
        </table>
    </div>

    <!-- ê³µëª¨ì „ ìƒì„¸ ë‚´ìš© -->
    <section class="contest-details">
        <div th:text="${contest.description}" id="contest-description">ìƒì„¸í˜ì´ì§€</div>
    </section>

    <!-- ë²„íŠ¼ ì˜ì—­ -->
    <div class="button-box" sec:authorize="!hasRole('ADMIN')">
        <button class="apply-btn" id="openModalBtn">ê³µëª¨ì „ ì°¸ê°€í•˜ê¸°</button>
        <button class="recruit-btn">íŒ€ì› ëª¨ì§‘ê¸€ ì‘ì„±í•˜ê¸°</button>
    </div>


    <!-- íŒ€ì› ëª¨ì§‘ê¸€ ë¦¬ìŠ¤íŠ¸ -->
    <section class="recruit-list">
        <h3>ğŸ“‹ íŒ€ì› ëª¨ì§‘ ê¸€</h3>
        <table class="recruit-table">
            <thead>
            <tr>
                <th>ì œëª©</th>
                <th>ì‘ì„±ì</th>
                <th>ëª¨ì§‘ ì¸ì›</th>
                <th>ë“±ë¡ì¼</th>
                <th>ìƒì„¸ë³´ê¸°</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="recruit : ${recruitList}">
                <td th:text="${recruit.title}">AI ê³µëª¨ì „ í•¨ê»˜í•˜ì‹¤ ë¶„!</td>
                <td th:text="${recruit.writer}">í™ê¸¸ë™</td>
                <td th:text="${recruit.recruitCount}">3ëª…</td>
                <td th:text="${#temporals.format(recruit.createdAt, 'yyyy.MM.dd')}">2025.03.20</td>
                <td><a th:href="@{'/recruit/' + ${recruit.id}}" class="detail-link">ë³´ê¸°</a></td>
            </tr>
            <tr th:if="${#lists.isEmpty(recruitList)}">
                <td colspan="5" style="text-align:center; color:gray;">ëª¨ì§‘ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
            </tbody>
        </table>
    </section>
</section>

<div id="contestModal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>ê³µëª¨ì „ ì°¸ê°€í•˜ê¸°</h2>

        <div class="invite-section">
            <label for="invite-input" id="invite-title">íŒ€ì› ë‹‰ë„¤ì„ ë˜ëŠ” ID</label>
            <input type="text" id="invite-input" placeholder="Enter nickname or ID" />

            <!-- ìë™ì™„ì„± ë¦¬ìŠ¤íŠ¸ -->
            <ul id="autocomplete-list" class="autocomplete-list"></ul>

            <!-- ì„ íƒëœ íŒ€ì›ë“¤ -->
            <div id="selected-members" class="selected-members"></div>
        </div>

        <button class="btn invite-btn">ğŸ‘¥ ì¹œêµ¬ì™€ í•¨ê»˜ ì°¸ê°€í•˜ê¸°</button>
        <button class="btn solo-btn">ğŸ§ í˜¼ì ì°¸ê°€í•˜ê¸°</button>

        <p class="terms">í˜¼ì ì°¸ê°€í•˜ê¸° ëˆŒëŸ¬ì„œ íŒ€ ëª¨ì§‘ì„ í†µí•´ ë‹¤ë¥¸ ì‚¬ìš©ìì™€ í•¨ê»˜ ì°¸ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
    </div>
</div>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        // ë¶ë§ˆí¬ í† ê¸€
        document.getElementById("bookmark-btn").addEventListener("click", function () {
            this.classList.toggle("active");
        });

        // ìƒíƒœ ë±ƒì§€ ë³€ê²½
        const statusBadge = document.getElementById("status-badge");

        const startDate = new Date([[${contest.startDate}]]);
        const endDate = new Date([[${contest.endDate}]]);
        const today = new Date();


        if (today > endDate) {
            statusBadge.textContent = "ì§„í–‰ì™„ë£Œ";
            statusBadge.style.backgroundColor = "#ff4040";
        } else {
            statusBadge.textContent = "ì§„í–‰ì¤‘";
            statusBadge.style.backgroundColor = "#02b902";
        }

        // ì°¸ì—¬í•˜ê¸° ë²„íŠ¼
        document.querySelector(".apply-btn").addEventListener("click", function () {
            document.getElementById("contestModal").style.display = "block";
        });

        // íŒ€ì› ëª¨ì§‘ê¸€ ì‘ì„±
        document.querySelector(".recruit-btn").addEventListener("click", function () {
            alert("íŒ€ì› ëª¨ì§‘ê¸€ ì‘ì„± í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
            window.location.href = "/newcontest";
        });
    });

    //ëª¨ë‹¬ì°½><
    document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById("contestModal");
        const openBtn = document.getElementById("openModalBtn");
        const closeBtn = document.querySelector(".close-btn");
        const inviteBtn = document.querySelector(".invite-btn");
        const soloBtn = document.querySelector(".solo-btn");
        const nicknameInput = document.getElementById("invite-input");

        openBtn.addEventListener("click", () => {
            modal.style.display = "block";
        });

        closeBtn.addEventListener("click", () => {
            modal.style.display = "none";
        });

        window.addEventListener("click", (e) => {
            if (e.target === modal) {
                modal.style.display = "none";
            }
        });

        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

        // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ëŠ” ì„œë²„ì—ì„œ ì„¸ì…˜/ì¸ì¦ì„ í†µí•´ ìë™ í¬í•¨ë¨
        inviteBtn.addEventListener("click", () => {
            const memberIds = selectedMembers(); // ì„ íƒëœ íŒ€ì›ë“¤

            if (memberIds.length === 0) {
                alert("í•¨ê»˜ ì°¸ê°€í•  íŒ€ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            fetch("/contest/team/create", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    [csrfHeader]: csrfToken
                },
                credentials: "include",
                body: JSON.stringify({
                    contestId: contestId,
                    memberIds: memberIds  // ë‚˜ + ì¹œêµ¬ë“¤ì€ ì„œë²„ì—ì„œ ì²˜ë¦¬
                })
            }).then(res => {
                if (res.ok) {
                    alert("íŒ€ ìƒì„± ì™„ë£Œ! ì¹œêµ¬ë“¤ì—ê²Œ ì´ˆëŒ€ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    modal.style.display = "none";
                    location.reload();
                } else {
                    alert("íŒ€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        });




        soloBtn.addEventListener("click", () => {
            fetch("/contest/team/create", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    [csrfHeader]: csrfToken
                },
                credentials: "include",
                body: JSON.stringify({
                    contestId: contestId,
                    memberIds: []  // ì•„ë¬´ë„ ì´ˆëŒ€í•˜ì§€ ì•ŠìŒ â†’ ë‚˜ í˜¼ìë§Œ í¬í•¨ë¨
                })
            }).then(res => {
                if (res.ok) {
                    alert("í˜¼ì ì°¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    modal.style.display = "none";
                    location.reload();
                } else {
                    alert("ì°¸ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            });
        });

    });

    const input = document.getElementById('invite-input');
    const list = document.getElementById('autocomplete-list');
    const selected = document.getElementById('selected-members');
    let selectedList = [];

    input.addEventListener('input', async () => {
        const query = input.value.trim().toLowerCase();
        list.innerHTML = '';

        if (!query) return;

        try {
            const response = await fetch(`/api/users/search?keyword=${encodeURIComponent(query)}`);
            const users = await response.json();

            users.forEach(user => {
                const li = document.createElement('li');
                li.textContent = `${user.nickname} (${user.id})`;
                li.addEventListener('click', () => {
                    if (!selectedList.some(sel => sel.userId === user.userId)) {
                        selectedList.push(user);
                        renderSelectedMembers();
                    }
                    input.value = '';
                    list.innerHTML = '';
                });
                list.appendChild(li);
            });
        } catch (error) {
            console.error('âŒ ìë™ì™„ì„± ì—ëŸ¬:', error);
        }
    });

    function renderSelectedMembers() {
        selected.innerHTML = '';
        selectedList.forEach(user => {
            const tag = document.createElement('div');
            tag.className = 'member-tag';
            tag.innerHTML = `
          <img src="${user.avatar}" alt="avatar" />
          ${user.nickname}
          <button onclick="removeMember(${user.userId})">&times;</button>
        `;
            selected.appendChild(tag);
        });
    }

    function removeMember(id) {
        selectedList = selectedList.filter(u => u.userId !== id);
        renderSelectedMembers();
    }


    // ìƒíƒœ ë±ƒì§€ ë³€ê²½
    const statusBadge = document.getElementById("status-badge");
    const start = new Date([[${contest.startDate}]]);
    const end = new Date([[${contest.endDate}]]);
    const today = new Date();

    if (today < start) {
        statusBadge.textContent = "ëª¨ì§‘ì „";
        statusBadge.style.backgroundColor = "#aaaaaa"; // íšŒìƒ‰
    } else if (today >= start && today <= end) {
        statusBadge.textContent = "ì§„í–‰ì¤‘";
        statusBadge.style.backgroundColor = "#0078ff"; // íŒŒë€ìƒ‰
    } else {
        statusBadge.textContent = "ì§„í–‰ì™„ë£Œ";
        statusBadge.style.backgroundColor = "#ff4040"; // ë¹¨ê°„ìƒ‰
    }

    // âœ… í˜„ì¬ ì„ íƒëœ ìœ ì € IDë§Œ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
    const selectedMembers = () => selectedList.map(user => user.userId);

    // âœ… ê³µëª¨ì „ ID ê°€ì ¸ì˜¤ê¸° (Thymeleafë¡œ ì£¼ì…)
    const contestId = /*[[${contest.id}]]*/ 0;

    // ì¹œêµ¬ì™€ í•¨ê»˜ ì°¸ê°€í•˜ê¸°
    inviteBtn.addEventListener("click", () => {
        const memberIds = selectedMembers();

        if (memberIds.length === 0) {
            alert("í•¨ê»˜ ì°¸ê°€í•  íŒ€ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }



        fetch("/contest/team/create", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                [csrfHeader]: csrfToken
            },
            credentials: "include",
            body: JSON.stringify({
                contestId: contestId,
                memberIds: memberIds
            })
        }).then(res => {
            if (res.ok) {
                alert("íŒ€ ìƒì„± ì™„ë£Œ! í•¨ê»˜ ì°¸ê°€í–ˆìŠµë‹ˆë‹¤.");
                modal.style.display = "none";
                location.reload();
            } else {
                alert("íŒ€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    });

    // í˜¼ì ì°¸ê°€í•˜ê¸°
    soloBtn.addEventListener("click", () => {
        fetch("/contest/team/create", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                [csrfHeader]: csrfToken
            },
            credentials: "include",
            body: JSON.stringify({
                contestId: contestId,
                memberIds: []  // ë³¸ì¸ë§Œ ì°¸ê°€
            })
        }).then(res => {
            if (res.ok) {
                alert("í˜¼ì ì°¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                modal.style.display = "none";
                location.reload();
            } else {
                alert("ì°¸ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    });


</script>
</body>
</html>
