<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title th:text="${contest.title}">공모전 상세보기</title>

  <link rel="stylesheet" href="/css/pocontest.css">
  <link rel="stylesheet" th:href="@{/css/header.css}">
</head>

<body>
<!-- header -->
<div th:insert="~{header :: header}"></div>

<!-- 제목과 모집현황 -->
<div class="title-row">
  <div class="title" th:text="${recruit.title}">공모전 제목</div>
  <span class="deadline" th:text="'D-' + ${contest.dDay}">D-14</span>
  <div class="status">
    모집현황
    <div class="team">
      <div id="yes"><img src="/images/team.png"></div>
      <div id="no"><img src="/images/user.png"><img src="/images/user.png"><img src="/images/user.png"></div>
    </div>
  </div>
  <div class="post-detail">
    <img class="postdetail" src="/images/postdetail.png" alt="점 세 개" onclick="toggleDropdown()" th:if="${isOwner}">
    <div class="dropdownmenu" id="dropdownMenu" style="display: none;" th:if="${isOwner}">
      <a class="action-button" th:href="@{'/recruit/' + ${contest.id} + '/edit'}">수정하기</a>
      <a class="action-button" href="javascript:void(0);" onclick="deleteContest()">삭제하기</a>
    </div>
  </div>
</div>
<hr>

<!-- 작성자 및 작성일 -->
<div class="meta">
  <a class="meta1"
     th:href="@{'/profileview?userNick=' + ${recruit.writer.userNick}}"
     th:text="${recruit.writer.userNick}">
    작성자
  </a>
  <span class="meta2" th:text="'작성일 : ' + ${today}">작성일</span>
</div>

<div class="form-group">
  <label for="contest-dates">진행 일정</label>
  <div class="date-inputs">
    <span id="start-date" th:text="${contest.startDate}"></span>
    <span>~</span>
    <span id="end-date" th:text="${contest.endDate}"></span>
  </div>
</div>

<div class="form-group">
  <label for="apply-dates">모집 일정</label>
  <div class="date-inputs">
    <span id="startdate" th:text="${recruit.recruitmentStartDate}"></span>
    <span>~</span>
    <span id="enddate" th:text="${recruit.recruitmentEndDate}"></span>
  </div>
</div>

<!-- 설명 -->
<div class="good">
  <p>내용</p>
  <div class="content" th:text="${recruit.description}">공모전 설명 내용</div>
</div>

<!-- 공모전 신청 버튼 -->
<button
        type="button"
        class="apply-btn"
        onclick="openModal()"
        th:disabled="${isOwner}"
        th:style="${isOwner} ? 'background: grey; cursor: not-allowed;' : ''">
  공모전 참가 신청하기
</button>
<p th:if="${isOwner}" style="color: red; font-size: 13px; margin-top: 5px;">
  본인이 작성한 공모전에는 신청할 수 없습니다.
</p>
<hr>

<!-- 좋아요 & 스크랩 -->
<div class="interaction">
  <div id="heart" onclick="toggleHeart()">
    <img id="heartImage" th:if="${isLiked}" src="/images/fillheart.png">
    <img id="heartImage" th:unless="${isLiked}" src="/images/heart.png">
    <span id="likesCount" th:text="${likesCount}">0</span>
  </div>
  <div id="scrap"><img src="/images/scrap.png"> <span>0</span></div>
</div>

<!-- 댓글 입력 -->
<form>
  <input type="text" class="comment-box" placeholder="댓글을 작성해주세요.">
  <button class="postbutton">등록</button>
</form>

<!-- 신청 모달 -->
<div id="applyModal" class="modal-overlay">
  <div class="modal-box">
    <p class="modal-title">신청하시겠습니까?</p>
    <p class="modal-sub"><span class="dot">•</span> 작성자에게 알림을 보냅니다.</p>
    <div class="modal-actions">
      <button onclick="closeModal()" class="modal-btn cancel">취소</button>
      <button onclick="confirmApply()" class="modal-btn confirm">확인</button>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script defer>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("🚀 JavaScript 로드 완료!");

    window.toggleDropdown = function () {
      var dropdown = document.getElementById("dropdownMenu");
      dropdown.style.display = (dropdown.style.display === "none" || dropdown.style.display === "") ? "block" : "none";
    };

    document.addEventListener("click", function (event) {
      var dropdown = document.getElementById("dropdownMenu");
      var button = document.querySelector(".postdetail");
      if (dropdown && !dropdown.contains(event.target) && !button.contains(event.target)) {
        dropdown.style.display = "none";
      }
    });

    window.deleteContest = function () {
      let recruitId = window.location.pathname.split("/")[2];

      if (!confirm("⚠️ 정말 삭제하시겠습니까? 삭제 후 복구할 수 없습니다!")) {
        return;
      }

      let csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
      let csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

      fetch(`/recruit/${recruitId}`, {
        method: "DELETE",
        headers: {
          [csrfHeader]: csrfToken,
          "Content-Type": "application/json"
        }
      })
              .then(response => {
                if (response.ok) {
                  alert("✅ 공모전이 삭제되었습니다.");
                  window.location.href = "/contest";
                } else {
                  return response.text().then(text => {
                    console.error("❌ 서버 응답 내용:", text);
                    alert("❌ 공모전 삭제에 실패했습니다.");
                  });
                }
              })
              .catch(error => {
                console.error("❌ 삭제 요청 실패:", error);
                alert("❌ 공모전 삭제 중 오류 발생");
              });
    };

    window.toggleHeart = function () {
      const contestId = window.location.pathname.split("/")[2];

      const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

      fetch(`/contest/${contestId}/like`, {
        method: 'POST',
        headers: {
          [csrfHeader]: csrfToken,
          'Content-Type': 'application/json'
        }
      })
              .then(response => response.json())
              .then(data => {
                const heartImg = document.getElementById("heartImage");
                heartImg.src = data.liked ? "/images/fillheart.png" : "/images/heart.png";
                document.getElementById("likesCount").innerText = data.likes;
              })
              .catch(error => {
                console.error("❌ 좋아요 처리 중 오류:", error);
                alert("❌ 좋아요 처리 실패");
              });
    };

    // 모달 관련 함수
    window.openModal = function () {
      document.getElementById("applyModal").style.display = "flex";
    };

    window.closeModal = function () {
      document.getElementById("applyModal").style.display = "none";
    };

    window.confirmApply = function () {
      const contestId = window.location.pathname.split("/")[2];
      window.location.href = `/contestapplication?contestId=${contestId}`;
    };
  });
</script>

</body>
</html>
