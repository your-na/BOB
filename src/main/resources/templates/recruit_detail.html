<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title th:text="${contest.title}">ê³µëª¨ì „ ìƒì„¸ë³´ê¸°</title>

  <link rel="stylesheet" href="/css/pocontest.css">
  <link rel="stylesheet" th:href="@{/css/header.css}">
</head>

<body>
<!-- header -->
<div th:insert="~{header :: header}"></div>

<!-- ì œëª©ê³¼ ëª¨ì§‘í˜„í™© -->
<div class="title-row">
  <div class="title" th:text="${recruit.title}">ê³µëª¨ì „ ì œëª©</div>
  <span class="deadline" th:text="'D-' + ${contest.dDay}">D-14</span>
  <div class="status">
    ëª¨ì§‘í˜„í™©
    <div class="team">
      <div id="yes"><img src="/images/team.png"></div>
      <div id="no"><img src="/images/user.png"><img src="/images/user.png"><img src="/images/user.png"></div>
    </div>
  </div>
  <div class="post-detail">
    <img class="postdetail" src="/images/postdetail.png" alt="ì  ì„¸ ê°œ" onclick="toggleDropdown()" th:if="${isOwner}">
    <div class="dropdownmenu" id="dropdownMenu" style="display: none;" th:if="${isOwner}">
      <a class="action-button" th:href="@{'/recruit/' + ${contest.id} + '/edit'}">ìˆ˜ì •í•˜ê¸°</a>
      <a class="action-button" href="javascript:void(0);" onclick="deleteContest()">ì‚­ì œí•˜ê¸°</a>
    </div>
  </div>
</div>
<hr>

<!-- ì‘ì„±ì ë° ì‘ì„±ì¼ -->
<div class="meta">
  <a class="meta1"
     th:href="@{'/profileview?userNick=' + ${recruit.writer.userNick}}"
     th:text="${recruit.writer.userNick}">
    ì‘ì„±ì
  </a>
  <span class="meta2" th:text="'ì‘ì„±ì¼ : ' + ${today}">ì‘ì„±ì¼</span>
</div>

<div class="form-group">
  <label for="contest-dates">ì§„í–‰ ì¼ì •</label>
  <div class="date-inputs">
    <span id="start-date" th:text="${contest.startDate}"></span>
    <span>~</span>
    <span id="end-date" th:text="${contest.endDate}"></span>
  </div>
</div>

<div class="form-group">
  <label for="apply-dates">ëª¨ì§‘ ì¼ì •</label>
  <div class="date-inputs">
    <span id="startdate" th:text="${recruit.recruitmentStartDate}"></span>
    <span>~</span>
    <span id="enddate" th:text="${recruit.recruitmentEndDate}"></span>
  </div>
</div>

<!-- ì„¤ëª… -->
<div class="good">
  <p>ë‚´ìš©</p>
  <div class="content" th:text="${recruit.description}">ê³µëª¨ì „ ì„¤ëª… ë‚´ìš©</div>
</div>

<!-- ê³µëª¨ì „ ì‹ ì²­ ë²„íŠ¼ -->
<button
        type="button"
        class="apply-btn"
        onclick="openModal()"
        th:disabled="${isOwner}"
        th:style="${isOwner} ? 'background: grey; cursor: not-allowed;' : ''">
  ê³µëª¨ì „ ì°¸ê°€ ì‹ ì²­í•˜ê¸°
</button>
<p th:if="${isOwner}" style="color: red; font-size: 13px; margin-top: 5px;">
  ë³¸ì¸ì´ ì‘ì„±í•œ ê³µëª¨ì „ì—ëŠ” ì‹ ì²­í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
</p>
<hr>

<!-- ì¢‹ì•„ìš” & ìŠ¤í¬ë© -->
<div class="interaction">
  <div id="heart" onclick="toggleHeart()">
    <img id="heartImage" th:if="${isLiked}" src="/images/fillheart.png">
    <img id="heartImage" th:unless="${isLiked}" src="/images/heart.png">
    <span id="likesCount" th:text="${likesCount}">0</span>
  </div>
  <div id="scrap"><img src="/images/scrap.png"> <span>0</span></div>
</div>

<!-- ëŒ“ê¸€ ì…ë ¥ -->
<form>
  <input type="text" class="comment-box" placeholder="ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.">
  <button class="postbutton">ë“±ë¡</button>
</form>

<!-- ì‹ ì²­ ëª¨ë‹¬ -->
<div id="applyModal" class="modal-overlay">
  <div class="modal-box">
    <p class="modal-title">ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    <p class="modal-sub"><span class="dot">â€¢</span> ì‘ì„±ìì—ê²Œ ì•Œë¦¼ì„ ë³´ëƒ…ë‹ˆë‹¤.</p>
    <div class="modal-actions">
      <button onclick="closeModal()" class="modal-btn cancel">ì·¨ì†Œ</button>
      <button onclick="confirmApply()" class="modal-btn confirm">í™•ì¸</button>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script defer>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("ğŸš€ JavaScript ë¡œë“œ ì™„ë£Œ!");

    window.toggleDropdown = function () {
      var dropdown = document.getElementById("dropdownMenu");
      dropdown.style.display = (dropdown.style.display === "none" || dropdown.style.display === "") ? "block" : "none";
    };

    document.addEventListener("click", function (event) {
      var dropdown = document.getElementById("dropdownMenu");
      var button = document.querySelector(".postdetail");
      if (dropdown && !dropdown.contains(event.target) && !button.contains(event.target)) {
        dropdown.style.display = "none";
      }
    });

    window.deleteContest = function () {
      let recruitId = window.location.pathname.split("/")[2];

      if (!confirm("âš ï¸ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì‚­ì œ í›„ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")) {
        return;
      }

      let csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
      let csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

      fetch(`/recruit/${recruitId}`, {
        method: "DELETE",
        headers: {
          [csrfHeader]: csrfToken,
          "Content-Type": "application/json"
        }
      })
              .then(response => {
                if (response.ok) {
                  alert("âœ… ê³µëª¨ì „ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                  window.location.href = "/contest";
                } else {
                  return response.text().then(text => {
                    console.error("âŒ ì„œë²„ ì‘ë‹µ ë‚´ìš©:", text);
                    alert("âŒ ê³µëª¨ì „ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                  });
                }
              })
              .catch(error => {
                console.error("âŒ ì‚­ì œ ìš”ì²­ ì‹¤íŒ¨:", error);
                alert("âŒ ê³µëª¨ì „ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
              });
    };

    window.toggleHeart = function () {
      const contestId = window.location.pathname.split("/")[2];

      const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

      fetch(`/contest/${contestId}/like`, {
        method: 'POST',
        headers: {
          [csrfHeader]: csrfToken,
          'Content-Type': 'application/json'
        }
      })
              .then(response => response.json())
              .then(data => {
                const heartImg = document.getElementById("heartImage");
                heartImg.src = data.liked ? "/images/fillheart.png" : "/images/heart.png";
                document.getElementById("likesCount").innerText = data.likes;
              })
              .catch(error => {
                console.error("âŒ ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:", error);
                alert("âŒ ì¢‹ì•„ìš” ì²˜ë¦¬ ì‹¤íŒ¨");
              });
    };

    // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
    window.openModal = function () {
      document.getElementById("applyModal").style.display = "flex";
    };

    window.closeModal = function () {
      document.getElementById("applyModal").style.display = "none";
    };

    window.confirmApply = function () {
      const contestId = window.location.pathname.split("/")[2];
      window.location.href = `/contestapplication?contestId=${contestId}`;
    };
  });
</script>

</body>
</html>
