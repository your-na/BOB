<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡œì íŠ¸</title>
    <link rel="stylesheet" href="/css/todo_home.css">

    <!-- âœ… CSRF í† í° ë©”íƒ€íƒœê·¸ ì¶”ê°€ -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <meta name="current-user" th:content="${loginNick}" />
    <meta name="current-user-id" th:content="${user.id}" />
</head>
<body>

<div class="container">
    <div class="modal">
        <div class="input-container">
            <div class="header">
                <button class="back-btn">&lt;</button>
                <!-- í”„ë¡œì íŠ¸ ì œëª©ì„ ë™ì ìœ¼ë¡œ ì¶œë ¥ -->
                <h2 id="project-name" th:text="${project.title != null ? project.title : 'ì œëª© ì—†ìŒ'}">í”„ë¡œì íŠ¸ ì œëª©</h2>
                <button class="close-btn">&times;</button>
            </div>

            <!-- í”„ë¡œì íŠ¸ ì •ë³´ -->
            <div class="project-info">
                <h3><strong>í™ˆ</strong></h3>

                <p><span th:text="'ì§„í–‰ì¼ì •: ' + ${project.startDate} + ' ~ ' + ${project.endDate}"></span></p>
            </div>

            <!-- ë²„íŠ¼ ì„¹ì…˜ -->
            <div class="button-group">
                <button class="submit-btn">ì œì¶œí•˜ê¸°</button>
                <button class="chat-btn">íŒ€ ì±„íŒ…</button>
            </div>

            <!-- ê³µì§€ì‚¬í•­ í…ìŠ¤íŠ¸ ì˜ì—­ -->
            <div class="notice-section">
                <textarea id="notice"
                          th:text="${team.notice}"
                          th:readonly="${ownerNick != loginNick}">
                </textarea>
            </div>

            <!-- ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ -->
            <div class="member-section">
                <h3>ë©¤ë²„</h3>
                <ul>
                    <!-- ì£¼ìµœì ì •ë³´ ì¶œë ¥ -->
                    <th:block th:if="${owner != null}">
                        <li class="member-item">
                            <div class="member-info">
                                <span class="member-name" th:text="${owner.userNick}"></span> <!-- ì£¼ìµœì ì´ë¦„ -->
                                <span class="crown">ğŸ‘‘</span> <!-- ì™•ê´€ ì•„ì´ì½˜ì„ ë‹‰ë„¤ì„ ë’¤ì— ë°°ì¹˜ -->
                            </div>
                            <button class="chat-send" th:attr="data-nick=${owner.userNick}">ì±„íŒ… ë³´ë‚´ê¸° ></button>
                        </li>
                    </th:block>

                    <!-- íŒ€ì› ëª©ë¡ì„ ë™ì ìœ¼ë¡œ ì¶œë ¥ -->
                    <th:block th:each="member : ${teamMembers}">
                        <li class="member-item">
                            <div class="member-info">
                                <!-- íŒ€ì›ì—ê²ŒëŠ” ì™•ê´€ ì•„ì´ì½˜ì„ í‘œì‹œí•˜ì§€ ì•ŠìŒ -->
                                <span class="member-name" th:text="${member}"></span> <!-- íŒ€ì› ì´ë¦„ -->
                            </div>
                            <button class="chat-send" th:attr="data-nick=${member}">ì±„íŒ… ë³´ë‚´ê¸° ></button>
                        </li>
                    </th:block>
                </ul>
            </div>
        </div>
    </div>

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
        <button class="sidebar-btn active">í™ˆ</button>
        <a th:href="@{/todo_plan2/{id}(id=${team.id})}">
            <button class="sidebar-btn">í•  ì¼</button>
        </a>
        <a th:href="@{'/todocrud/contest/' + ${team.id}}">
            <button class="sidebar-btn">WBS</button>
        </a>

        <button class="sidebar-btn">+</button>
    </div>
</div>

<!-- âœ… ê³µì§€ì‚¬í•­ ìë™ ì €ì¥ ë° ë²„íŠ¼ ì´ë™ ìŠ¤í¬ë¦½íŠ¸ -->
<script th:inline="javascript">
    let teamId = /*[[${team.id}]]*/ 0;
    let csrfToken = /*[['${_csrf.token}']]*/ '';
    let csrfHeader = /*[['${_csrf.headerName}']]*/ '';
</script>


<script>
    document.addEventListener("DOMContentLoaded", function () {

        // âœ… í˜ì´ì§€ ì´ë™: ì™¼ìª½ < ë²„íŠ¼ â†’ plan í˜ì´ì§€
        const backBtn = document.querySelector(".back-btn");
        if (backBtn) {
            backBtn.addEventListener("click", function () {
                window.location.href = "http://localhost:8888/plan";
            });
        }

        // âœ… í˜ì´ì§€ ì´ë™: ì˜¤ë¥¸ìª½ X ë²„íŠ¼ â†’ main í˜ì´ì§€
        const closeBtn = document.querySelector(".close-btn");
        if (closeBtn) {
            closeBtn.addEventListener("click", function () {
                window.location.href = "http://localhost:8888/main";
            });
        }

        // âœ… ê³µì§€ì‚¬í•­ ìë™ ì €ì¥ ì²˜ë¦¬
        const textarea = document.getElementById("notice");
        let timer = null;

        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

        // ë‚´ìš©ì´ ë°”ë€Œë©´ 2ì´ˆ í›„ ì €ì¥
        textarea?.addEventListener("input", function () {
            if (textarea.readOnly) return;
            if (timer) clearTimeout(timer);
            timer = setTimeout(saveNotice, 2000);
        });

        // í¬ì»¤ìŠ¤ ë²—ì–´ë‚  ë•Œ ì €ì¥
        textarea?.addEventListener("blur", function () {
            if (textarea.readOnly) return;
            saveNotice();
        });

        function saveNotice() {
            fetch(`/api/contest/team/${teamId}/notice`, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({ content: textarea.value })
            }).then(() => console.log("âœ… ê³µì§€ ì €ì¥ë¨"))
                .catch(err => console.error("âŒ ê³µì§€ ì €ì¥ ì‹¤íŒ¨", err));
        }

        const currentUserNick = document.querySelector("meta[name='current-user']")?.content;

        document.querySelectorAll(".chat-send").forEach(btn => {
            btn.addEventListener("click", function () {
                const targetNick = btn.dataset.nick;

                if (!targetNick || targetNick === currentUserNick) {
                    alert("ë³¸ì¸ì—ê²ŒëŠ” ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                fetch(`/chat/room?userA=${currentUserNick}&userB=${targetNick}`, {
                    method: "GET",
                    credentials: "include"
                })
                    .then(res => res.json())
                    .then(roomId => {
                        window.open(`/chat/chatroom?roomId=${roomId}`, "_blank", "width=500,height=700");
                    })
                    .catch(err => {
                        alert("ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨");
                        console.error(err);
                    });
            });
        });
    });

    // íŒ€ ì±„íŒ… ë²„íŠ¼ ì²˜ë¦¬
    document.querySelector(".chat-btn").addEventListener("click", () => {
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

        fetch(`/api/chat/group/team/${teamId}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                [csrfHeader]: csrfToken
            }
        })
            .then(res => {
                if (!res.ok) throw new Error("íŒ€ ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨");
                return res.json();  // ë°˜í™˜ê°’ì´ Long
            })
            .then(data => {
                if (!data || !data.roomId) {
                    throw new Error("ì˜ëª»ëœ ì‘ë‹µ");
                }
                const roomId = typeof data === "object" ? data.roomId ?? data.id : data;
                window.open(`/chat/group-chatroom?roomId=${roomId}&type=group`, "_blank", "width=500,height=700");
            })
            .catch(err => {
                alert("ì±„íŒ… ì—´ê¸° ì‹¤íŒ¨");
                console.error(err);
            });
    });
</script>
</body>
</html>
