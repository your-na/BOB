<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프로젝트</title>
    <link rel="stylesheet" href="/css/todo_home.css">

    <!-- ✅ CSRF 토큰 메타태그 추가 -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <meta name="current-user" th:content="${loginNick}" />
    <meta name="current-user-id" th:content="${user.id}" />
</head>
<body>

<div class="container">
    <div class="modal">
        <div class="input-container">
            <div class="header">
                <button class="back-btn">&lt;</button>
                <!-- 프로젝트 제목을 동적으로 출력 -->
                <h2 id="project-name" th:text="${project.title != null ? project.title : '제목 없음'}">프로젝트 제목</h2>
                <button class="close-btn">&times;</button>
            </div>

            <!-- 프로젝트 정보 -->
            <div class="project-info">
                <h3><strong>홈</strong></h3>

                <p><span th:text="'진행일정: ' + ${project.startDate} + ' ~ ' + ${project.endDate}"></span></p>
            </div>

            <!-- 버튼 섹션 -->
            <div class="button-group">
                <button class="submit-btn">제출하기</button>
                <button class="chat-btn">팀 채팅</button>
            </div>

            <!-- 공지사항 텍스트 영역 -->
            <div class="notice-section">
                <textarea id="notice"
                          th:text="${team.notice}"
                          th:readonly="${ownerNick != loginNick}">
                </textarea>
            </div>

            <!-- 멤버 리스트 -->
            <div class="member-section">
                <h3>멤버</h3>
                <ul>
                    <!-- 주최자 정보 출력 -->
                    <th:block th:if="${owner != null}">
                        <li class="member-item">
                            <div class="member-info">
                                <span class="member-name" th:text="${owner.userNick}"></span> <!-- 주최자 이름 -->
                                <span class="crown">👑</span> <!-- 왕관 아이콘을 닉네임 뒤에 배치 -->
                            </div>
                            <button class="chat-send" th:attr="data-nick=${owner.userNick}">채팅 보내기 ></button>
                        </li>
                    </th:block>

                    <!-- 팀원 목록을 동적으로 출력 -->
                    <th:block th:each="member : ${teamMembers}">
                        <li class="member-item">
                            <div class="member-info">
                                <!-- 팀원에게는 왕관 아이콘을 표시하지 않음 -->
                                <span class="member-name" th:text="${member}"></span> <!-- 팀원 이름 -->
                            </div>
                            <button class="chat-send" th:attr="data-nick=${member}">채팅 보내기 ></button>
                        </li>
                    </th:block>
                </ul>
            </div>
        </div>
    </div>

    <!-- 사이드바 -->
    <div class="sidebar">
        <button class="sidebar-btn active">홈</button>
        <a th:href="@{/todo_plan2/{id}(id=${team.id})}">
            <button class="sidebar-btn">할 일</button>
        </a>
        <a th:href="@{'/todocrud/contest/' + ${team.id}}">
            <button class="sidebar-btn">WBS</button>
        </a>

        <button class="sidebar-btn">+</button>
    </div>
</div>

<!-- ✅ 공지사항 자동 저장 및 버튼 이동 스크립트 -->
<script th:inline="javascript">
    let teamId = /*[[${team.id}]]*/ 0;
    let csrfToken = /*[['${_csrf.token}']]*/ '';
    let csrfHeader = /*[['${_csrf.headerName}']]*/ '';
</script>


<script>
    document.addEventListener("DOMContentLoaded", function () {

        // ✅ 페이지 이동: 왼쪽 < 버튼 → plan 페이지
        const backBtn = document.querySelector(".back-btn");
        if (backBtn) {
            backBtn.addEventListener("click", function () {
                window.location.href = "http://localhost:8888/plan";
            });
        }

        // ✅ 페이지 이동: 오른쪽 X 버튼 → main 페이지
        const closeBtn = document.querySelector(".close-btn");
        if (closeBtn) {
            closeBtn.addEventListener("click", function () {
                window.location.href = "http://localhost:8888/main";
            });
        }

        // ✅ 공지사항 자동 저장 처리
        const textarea = document.getElementById("notice");
        let timer = null;

        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

        // 내용이 바뀌면 2초 후 저장
        textarea?.addEventListener("input", function () {
            if (textarea.readOnly) return;
            if (timer) clearTimeout(timer);
            timer = setTimeout(saveNotice, 2000);
        });

        // 포커스 벗어날 때 저장
        textarea?.addEventListener("blur", function () {
            if (textarea.readOnly) return;
            saveNotice();
        });

        function saveNotice() {
            fetch(`/api/contest/team/${teamId}/notice`, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({ content: textarea.value })
            }).then(() => console.log("✅ 공지 저장됨"))
                .catch(err => console.error("❌ 공지 저장 실패", err));
        }

        const currentUserNick = document.querySelector("meta[name='current-user']")?.content;

        document.querySelectorAll(".chat-send").forEach(btn => {
            btn.addEventListener("click", function () {
                const targetNick = btn.dataset.nick;

                if (!targetNick || targetNick === currentUserNick) {
                    alert("본인에게는 메시지를 보낼 수 없습니다.");
                    return;
                }

                fetch(`/chat/room?userA=${currentUserNick}&userB=${targetNick}`, {
                    method: "GET",
                    credentials: "include"
                })
                    .then(res => res.json())
                    .then(roomId => {
                        window.open(`/chat/chatroom?roomId=${roomId}`, "_blank", "width=500,height=700");
                    })
                    .catch(err => {
                        alert("채팅방 생성 실패");
                        console.error(err);
                    });
            });
        });
    });

    // 팀 채팅 버튼 처리
    document.querySelector(".chat-btn").addEventListener("click", () => {
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

        fetch(`/api/chat/group/team/${teamId}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                [csrfHeader]: csrfToken
            }
        })
            .then(res => {
                if (!res.ok) throw new Error("팀 채팅방 생성 실패");
                return res.json();  // 반환값이 Long
            })
            .then(data => {
                if (!data || !data.roomId) {
                    throw new Error("잘못된 응답");
                }
                const roomId = typeof data === "object" ? data.roomId ?? data.id : data;
                window.open(`/chat/group-chatroom?roomId=${roomId}&type=group`, "_blank", "width=500,height=700");
            })
            .catch(err => {
                alert("채팅 열기 실패");
                console.error(err);
            });
    });
</script>
</body>
</html>
