<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÌîÑÎ°úÏ†ùÌä∏</title>
    <link rel="stylesheet" href="/css/todo_home.css">

    <!-- ‚úÖ CSRF ÌÜ†ÌÅ∞ Î©îÌÉÄÌÉúÍ∑∏ Ï∂îÍ∞Ä -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>

<div class="container">
    <div class="modal">
        <div class="input-container">
            <div class="header">
                <button class="back-btn">&lt;</button>
                <!-- ÌîÑÎ°úÏ†ùÌä∏ Ï†úÎ™©ÏùÑ ÎèôÏ†ÅÏúºÎ°ú Ï∂úÎ†• -->
                <h2 id="project-name" th:text="${project.title != null ? project.title : 'Ï†úÎ™© ÏóÜÏùå'}">ÌîÑÎ°úÏ†ùÌä∏ Ï†úÎ™©</h2>
                <button class="close-btn">&times;</button>
            </div>

            <!-- ÌîÑÎ°úÏ†ùÌä∏ Ï†ïÎ≥¥ -->
            <div class="project-info">
                <h3><strong>Ìôà</strong></h3>
                <!-- ÌîÑÎ°úÏ†ùÌä∏ Î™©ÌëúÏôÄ ÏßÑÌñâÏùºÏ†ïÏùÑ ÎèôÏ†ÅÏúºÎ°ú Ï∂úÎ†• -->
                <p th:text="'Î™©Ìëú: ' + ${goal}"></p>
                <p><span th:text="'ÏßÑÌñâÏùºÏ†ï: ' + ${project.startDate} + ' ~ ' + ${project.endDate}"></span></p>
            </div>

            <!-- Î≤ÑÌäº ÏÑπÏÖò -->
            <div class="button-group">
                <button class="submit-btn">Ï†úÏ∂úÌïòÍ∏∞</button>
                <button class="chat-btn">ÌåÄ Ï±ÑÌåÖ</button>
            </div>

            <!-- Í≥µÏßÄÏÇ¨Ìï≠ ÌÖçÏä§Ìä∏ ÏòÅÏó≠ -->
            <div class="notice-section">
                <textarea id="notice"
                          th:text="${project.notice}"
                          th:readonly="${owner.userNick != #authentication.principal.userEntity.userNick}">
                </textarea>
            </div>

            <!-- Î©§Î≤Ñ Î¶¨Ïä§Ìä∏ -->
            <div class="member-section">
                <h3>Î©§Î≤Ñ</h3>
                <ul>
                    <!-- Ï£ºÏµúÏûê Ï†ïÎ≥¥ Ï∂úÎ†• -->
                    <th:block th:if="${owner != null}">
                        <li class="member-item">
                            <div class="member-info">
                                <span class="member-name" th:text="${owner.userNick}"></span> <!-- Ï£ºÏµúÏûê Ïù¥Î¶Ñ -->
                                <span class="crown">üëë</span> <!-- ÏôïÍ¥Ä ÏïÑÏù¥ÏΩòÏùÑ ÎãâÎÑ§ÏûÑ Îí§Ïóê Î∞∞Ïπò -->
                            </div>
                            <button class="chat-send">Ï±ÑÌåÖ Î≥¥ÎÇ¥Í∏∞ ></button>
                        </li>
                    </th:block>

                    <!-- ÌåÄÏõê Î™©Î°ùÏùÑ ÎèôÏ†ÅÏúºÎ°ú Ï∂úÎ†• -->
                    <th:block th:each="member : ${teamMembers}">
                        <li class="member-item">
                            <div class="member-info">
                                <!-- ÌåÄÏõêÏóêÍ≤åÎäî ÏôïÍ¥Ä ÏïÑÏù¥ÏΩòÏùÑ ÌëúÏãúÌïòÏßÄ ÏïäÏùå -->
                                <span class="member-name" th:text="${member}"></span> <!-- ÌåÄÏõê Ïù¥Î¶Ñ -->
                            </div>
                            <button class="chat-send">Ï±ÑÌåÖ Î≥¥ÎÇ¥Í∏∞ ></button>
                        </li>
                    </th:block>
                </ul>
            </div>
        </div>
    </div>

    <!-- ÏÇ¨Ïù¥ÎìúÎ∞î -->
    <div class="sidebar">
        <button class="sidebar-btn active">Ìôà</button>
        <a th:href="@{/todo_plan}">
            <button class="sidebar-btn">Ìï† Ïùº</button>
        </a>
        <a th:href="@{'/todocrud/' + ${project.id}}">
            <button class="sidebar-btn">CRUD</button>
        </a>

        <button class="sidebar-btn">+</button>
    </div>
</div>

<!-- ‚úÖ Í≥µÏßÄÏÇ¨Ìï≠ ÏûêÎèô Ï†ÄÏû• Î∞è Î≤ÑÌäº Ïù¥Îèô Ïä§ÌÅ¨Î¶ΩÌä∏ -->
<script th:inline="javascript">
    /*<![CDATA[*/
    let projectId = /*[[${project.id}]]*/ 0;
    /*]]>*/
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // ‚úÖ ÌéòÏù¥ÏßÄ Ïù¥Îèô: ÏôºÏ™Ω < Î≤ÑÌäº ‚Üí plan ÌéòÏù¥ÏßÄ
        const backBtn = document.querySelector(".back-btn");
        if (backBtn) {
            backBtn.addEventListener("click", function () {
                window.location.href = "http://localhost:8888/plan";
            });
        }

        // ‚úÖ ÌéòÏù¥ÏßÄ Ïù¥Îèô: Ïò§Î•∏Ï™Ω X Î≤ÑÌäº ‚Üí main ÌéòÏù¥ÏßÄ
        const closeBtn = document.querySelector(".close-btn");
        if (closeBtn) {
            closeBtn.addEventListener("click", function () {
                window.location.href = "http://localhost:8888/main";
            });
        }

        // ‚úÖ Í≥µÏßÄÏÇ¨Ìï≠ ÏûêÎèô Ï†ÄÏû• Ï≤òÎ¶¨
        const textarea = document.getElementById("notice");
        let timer = null;

        const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

        // ÎÇ¥Ïö©Ïù¥ Î∞îÎÄåÎ©¥ 2Ï¥à ÌõÑ Ï†ÄÏû•
        textarea?.addEventListener("input", function () {
            if (textarea.readOnly) return;
            if (timer) clearTimeout(timer);
            timer = setTimeout(saveNotice, 2000);
        });

        // Ìè¨Ïª§Ïä§ Î≤óÏñ¥ÎÇ† Îïå Ï†ÄÏû•
        textarea?.addEventListener("blur", function () {
            if (textarea.readOnly) return;
            saveNotice();
        });

        function saveNotice() {
            if (!textarea || textarea.readOnly) return;

            fetch(`/api/project/${projectId}/notice`, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({ content: textarea.value })
            }).then(() => {
                console.log("‚úÖ Í≥µÏßÄÏÇ¨Ìï≠ Ï†ÄÏû•Îê®");
            }).catch((error) => {
                console.error("‚ùå Ï†ÄÏû• Ïã§Ìå®:", error);
            });
        }
    });
</script>


</body>
</html>
